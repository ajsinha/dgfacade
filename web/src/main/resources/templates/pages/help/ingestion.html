<!DOCTYPE html>
<!--
  ~ Copyright © 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  ~ Proprietary and confidential. Patent Pending.
  -->
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('Request Ingestion Guide')}"></head>
<body class="d-flex flex-column min-vh-100">
<nav th:replace="~{fragments/layout :: navbar}"></nav>
<main class="flex-fill">
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2">
                        <li class="breadcrumb-item"><a th:href="@{/help}">Help</a></li>
                        <li class="breadcrumb-item active">Request Ingestion</li>
                    </ol>
                </nav>
                <h2 class="mb-1"><i class="fas fa-download me-2"></i>Request Ingestion Guide</h2>
                <p class="text-muted">How DGFacade receives requests from Kafka, ActiveMQ, and filesystem sources</p>
            </div>
        </div>

        <!-- Table of Contents -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-primary text-white py-3">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Contents</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <ol class="mb-0">
                            <li><a href="#overview">Overview</a></li>
                            <li><a href="#architecture">Architecture</a></li>
                            <li><a href="#ingester-types">Ingester Types</a></li>
                            <li><a href="#configuration">Configuration</a></li>
                        </ol>
                    </div>
                    <div class="col-md-4">
                        <ol start="5" class="mb-0">
                            <li><a href="#request-format">Request JSON Format</a></li>
                            <li><a href="#lifecycle">Ingester Lifecycle</a></li>
                            <li><a href="#processing-flow">Processing Flow</a></li>
                            <li><a href="#error-handling">Error Handling</a></li>
                        </ol>
                    </div>
                    <div class="col-md-4">
                        <ol start="9" class="mb-0">
                            <li><a href="#monitoring">Monitoring &amp; Stats</a></li>
                            <li><a href="#manual-testing">Manual Testing</a></li>
                            <li><a href="#examples">Complete Examples</a></li>
                            <li><a href="#troubleshooting">Troubleshooting</a></li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 1: Overview -->
        <div class="card border-0 shadow-sm mb-4" id="overview">
            <div class="card-header bg-white border-0 py-3">
                <h4 class="mb-0"><span class="badge bg-primary me-2">1</span>Overview</h4>
            </div>
            <div class="card-body">
                <p>DGFacade supports <strong>five ingestion paths</strong> for receiving requests:</p>
                <div class="row g-3 mb-3">
                    <div class="col-md">
                        <div class="card border-primary h-100">
                            <div class="card-body text-center py-3">
                                <i class="fas fa-globe fa-2x text-primary mb-2"></i>
                                <div class="fw-bold">REST API</div>
                                <small class="text-muted">POST /api/v1/request</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md">
                        <div class="card border-info h-100">
                            <div class="card-body text-center py-3">
                                <i class="fas fa-plug fa-2x text-info mb-2"></i>
                                <div class="fw-bold">WebSocket</div>
                                <small class="text-muted">ws://host:8090/ws/gateway</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md">
                        <div class="card border-dark h-100">
                            <div class="card-body text-center py-3">
                                <i class="fas fa-stream fa-2x text-dark mb-2"></i>
                                <div class="fw-bold">Kafka</div>
                                <small class="text-muted">Topic subscription</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md">
                        <div class="card border-warning h-100">
                            <div class="card-body text-center py-3">
                                <i class="fas fa-envelope fa-2x text-warning mb-2"></i>
                                <div class="fw-bold">ActiveMQ</div>
                                <small class="text-muted">Queue/topic listener</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md">
                        <div class="card border-success h-100">
                            <div class="card-body text-center py-3">
                                <i class="fas fa-folder fa-2x text-success mb-2"></i>
                                <div class="fw-bold">FileSystem</div>
                                <small class="text-muted">Directory poll</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info border-0 mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Key principle:</strong> The request JSON format is <strong>identical</strong> regardless of the ingestion source.
                    A <code>DGRequest</code> submitted via REST, Kafka, ActiveMQ, or filesystem all follow the same schema and
                    flow through the same ExecutionEngine → Actor → Handler pipeline.
                </div>
            </div>
        </div>

        <!-- Section 2: Architecture -->
        <div class="card border-0 shadow-sm mb-4" id="architecture">
            <div class="card-header bg-white border-0 py-3">
                <h4 class="mb-0"><span class="badge bg-primary me-2">2</span>Architecture</h4>
            </div>
            <div class="card-body">
                <p>Ingesters follow DGFacade's standard <strong>broker → input channel</strong> pattern.
                    Each ingester references an <em>input channel</em> (which defines destinations like topics/queues/directories),
                    and each input channel references a <em>broker</em> (which defines connection details like hostnames, credentials, and SSL).</p>

                <div class="alert alert-info border-0 mb-4">
                    <i class="fas fa-layer-group me-2"></i>
                    <strong>Resolution chain:</strong>
                    <code>config/ingesters/*.json</code> → <code>config/input-channels/*.json</code> → <code>config/brokers/*.json</code>
                </div>
<pre class="bg-dark text-light p-3 rounded small" style="line-height: 1.6;">
<span class="text-warning">  ┌──────────────────────────────────────────────────────────────────────┐</span>
<span class="text-warning">  │                  Configuration Resolution Chain                      │</span>
<span class="text-warning">  └──────────────────────────────────────────────────────────────────────┘</span>

  <span class="text-info">config/ingesters/</span>           <span class="text-success">config/input-channels/</span>       <span class="text-warning">config/brokers/</span>
  ┌───────────────────┐      ┌────────────────────┐      ┌──────────────────┐
  │ <span class="text-info">kafka-requests</span>    │─────▶│ <span class="text-success">kafka-requests</span>     │─────▶│ <span class="text-warning">dev-kafka</span>        │
  │  input_channel:   │      │  broker: dev-kafka  │      │  bootstrap_servers│
  │  "kafka-requests" │      │  destinations:      │      │  group_id         │
  │  overrides:       │      │   - dgfacade.reqs   │      │  SSL, properties  │
  │   group_id: ...   │      └────────────────────┘      └──────────────────┘
  └───────────────────┘
  ┌───────────────────┐      ┌────────────────────┐      ┌──────────────────┐
  │ <span class="text-info">activemq-requests</span> │─────▶│ <span class="text-success">activemq-requests</span>  │─────▶│ <span class="text-warning">dev-activemq</span>     │
  │  input_channel:   │      │  broker: dev-amq    │      │  broker_url       │
  │  "activemq-reqs"  │      │  destinations:      │      │  username, passwd │
  └───────────────────┘      │   - DGFACADE.REQS   │      └──────────────────┘
                             └────────────────────┘
  ┌───────────────────┐      ┌────────────────────┐      ┌──────────────────┐
  │ <span class="text-info">filesystem-batch</span>  │─────▶│ <span class="text-success">batch-requests</span>     │─────▶│ <span class="text-warning">dev-filesystem</span>   │
  │  input_channel:   │      │  broker: dev-fs     │      │  base_dir         │
  │  "batch-requests" │      │  destinations:      │      │  file_pattern     │
  └───────────────────┘      │   - requests (dir)  │      │  poll_interval    │
                             └────────────────────┘      └──────────────────┘
</pre>

<pre class="bg-dark text-light p-3 rounded small mt-3" style="line-height: 1.6;">
<span class="text-warning">  ┌────────────────────────────────────────────────────────────────────┐</span>
<span class="text-warning">  │                   Runtime Execution Flow                           │</span>
<span class="text-warning">  └──────────┬───────────────┬───────────────┬────────────────────────┘</span>
             │               │               │
  <span class="text-info">┌──────────▼──────┐ ┌──────▼──────┐ ┌──────▼──────────┐</span>
  <span class="text-info">│  Kafka Ingester │ │  ActiveMQ   │ │  FileSystem     │</span>
  <span class="text-info">│  (poll loop)    │ │  Ingester   │ │  Ingester       │</span>
  <span class="text-info">│  Thread: kafka-1│ │  (JMS async)│ │  (scheduled)    │</span>
  <span class="text-info">└────────┬────────┘ └──────┬──────┘ └───────┬─────────┘</span>
           │                │                 │
           ▼                ▼                 ▼
  <span class="text-success">┌──────────────────────────────────────────────────────┐</span>
  <span class="text-success">│           AbstractRequestIngester.processMessage()    │</span>
  <span class="text-success">│  ┌─────────────┐  ┌──────────┐  ┌────────────────┐   │</span>
  <span class="text-success">│  │ Deserialize  │→ │ Validate │→ │ Enrich request │   │</span>
  <span class="text-success">│  │ JSON→DGReq   │  │ api_key  │  │ sourceChannel  │   │</span>
  <span class="text-success">│  └─────────────┘  └──────────┘  └────────────────┘   │</span>
  <span class="text-success">└──────────────────────┬───────────────────────────────┘</span>
                       │
                       ▼
  <span class="text-primary">┌────────────────────────────────────┐</span>
  <span class="text-primary">│  ExecutionEngine.submit(request)   │</span>
  <span class="text-primary">│  → HandlerActor → Handler.execute()│</span>
  <span class="text-primary">└────────────────────────────────────┘</span>
</pre>
                <div class="row g-3 mt-2">
                    <div class="col-md-4">
                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <h6><i class="fas fa-link text-primary me-1"></i>Broker &amp; Channel Reuse</h6>
                                <p class="small mb-0">Ingesters share the same broker and input channel configurations
                                    used by handlers via ChannelAccessor. No duplication of connection details.
                                    Change a broker config once and all consumers update on restart.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <h6><i class="fas fa-layer-group text-success me-1"></i>Dedicated Listener per Ingester</h6>
                                <p class="small mb-0">Each configured ingester gets its own thread/listener.
                                    Multiple ingesters can reference the same input channel with different overrides
                                    (e.g., different consumer groups for parallel processing).</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <h6><i class="fas fa-exchange-alt text-warning me-1"></i>Unified Pipeline</h6>
                                <p class="small mb-0">Regardless of source, every request flows through the same pipeline:
                                    JSON deserialization → field validation → enrichment → ExecutionEngine → HandlerActor →
                                    Handler.execute(). The source is recorded in <code>sourceChannel</code>.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 3: Ingester Types -->
        <div class="card border-0 shadow-sm mb-4" id="ingester-types">
            <div class="card-header bg-white border-0 py-3">
                <h4 class="mb-0"><span class="badge bg-primary me-2">3</span>Ingester Types</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table dg-table table-bordered" data-no-search="true" data-no-sort="true">
                        <thead class="table-dark">
                            <tr>
                                <th style="min-width: 120px">Type</th>
                                <th>Broker Type</th>
                                <th>Channel Destinations</th>
                                <th>Threading Model</th>
                                <th>Best For</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><i class="fas fa-stream text-dark me-1"></i><strong>Kafka</strong></td>
                                <td><code>kafka</code> broker</td>
                                <td>One or more topics defined in input channel</td>
                                <td>Single-threaded poll loop (500ms). Consumer group from broker config, overridable per ingester.</td>
                                <td>High-throughput event streams, microservice integration</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-envelope text-warning me-1"></i><strong>ActiveMQ</strong></td>
                                <td><code>activemq</code> broker</td>
                                <td>JMS queues and/or topics defined in input channel</td>
                                <td>Asynchronous JMS MessageListener — one per destination. No polling required.</td>
                                <td>Enterprise JMS integration, queue-based workload distribution</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-folder text-success me-1"></i><strong>FileSystem</strong></td>
                                <td><code>filesystem</code> broker</td>
                                <td>Directory name from input channel, base path from broker</td>
                                <td>ScheduledExecutorService polls directory. Files processed in <strong>chronological order</strong> (oldest first).</td>
                                <td>Batch processing, file-drop integration, legacy system adapters</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Section 4: Configuration -->
        <div class="card border-0 shadow-sm mb-4" id="configuration">
            <div class="card-header bg-white border-0 py-3">
                <h4 class="mb-0"><span class="badge bg-primary me-2">4</span>Configuration</h4>
            </div>
            <div class="card-body">
                <p>Ingesters are configured through the standard three-layer pattern.
                    Each layer is a separate JSON file, promoting <strong>reuse</strong> and <strong>separation of concerns</strong>.</p>

                <div class="alert alert-success border-0 mb-4">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Key principle:</strong> Connection details live in the <em>broker</em>, destinations live in the <em>input channel</em>,
                    and the <em>ingester</em> simply wires them together with optional overrides. No connection info is duplicated in the ingester config.
                </div>

                <!-- Layer 1: Broker -->
                <h5 class="mt-4 border-bottom pb-2"><span class="badge bg-warning text-dark me-2">Layer 1</span>Broker — Connection Details</h5>
                <p>Brokers define <em>how to connect</em>. These are the same broker configs used by handlers and ChannelAccessor.</p>

                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <p class="fw-bold mb-1"><i class="fas fa-stream text-dark me-1"></i>config/brokers/dev-kafka.json</p>
<pre class="bg-dark text-light p-3 rounded small">{
  "type": "kafka",
  "description": "Development Kafka broker",
  "enabled": true,
  "connection": {
    "bootstrap_servers": "localhost:9092",
    "group_id": "dgfacade-consumer-group",
    "auto_offset_reset": "latest",
    "max_poll_records": 500
  },
  "properties": {
    "request.timeout.ms": "30000",
    "session.timeout.ms": "10000"
  }
}</pre>
                    </div>
                    <div class="col-md-4">
                        <p class="fw-bold mb-1"><i class="fas fa-envelope text-warning me-1"></i>config/brokers/dev-activemq.json</p>
<pre class="bg-dark text-light p-3 rounded small">{
  "type": "activemq",
  "description": "Development ActiveMQ broker",
  "enabled": true,
  "connection": {
    "broker_url": "tcp://localhost:61616",
    "username": "admin",
    "password": "admin"
  }
}</pre>
                    </div>
                    <div class="col-md-4">
                        <p class="fw-bold mb-1"><i class="fas fa-folder text-success me-1"></i>config/brokers/dev-filesystem.json</p>
<pre class="bg-dark text-light p-3 rounded small">{
  "type": "filesystem",
  "description": "Local filesystem broker",
  "enabled": true,
  "connection": {
    "base_dir": "./data/ingest",
    "file_pattern": "*.json",
    "poll_interval_seconds": 10,
    "max_files_per_poll": 100
  }
}</pre>
                    </div>
                </div>

                <!-- Layer 2: Input Channel -->
                <h5 class="mt-4 border-bottom pb-2"><span class="badge bg-success me-2">Layer 2</span>Input Channel — Destinations</h5>
                <p>Input channels define <em>what to listen to</em> on a specific broker — topics, queues, or directories.</p>

                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <p class="fw-bold mb-1">config/input-channels/kafka-requests.json</p>
<pre class="bg-dark text-light p-3 rounded small">{
  "type": "kafka",
  "description": "Request ingestion topic",
  "enabled": true,
  <span class="text-warning">"broker": "dev-kafka"</span>,
  "destinations": [
    { "name": "dgfacade.requests",
      "type": "topic" }
  ]
}</pre>
                    </div>
                    <div class="col-md-4">
                        <p class="fw-bold mb-1">config/input-channels/activemq-requests.json</p>
<pre class="bg-dark text-light p-3 rounded small">{
  "type": "jms",
  "description": "Request ingestion queue",
  "enabled": true,
  <span class="text-warning">"broker": "dev-activemq"</span>,
  "destinations": [
    { "name": "DGFACADE.REQUESTS",
      "type": "queue" }
  ]
}</pre>
                    </div>
                    <div class="col-md-4">
                        <p class="fw-bold mb-1">config/input-channels/batch-requests.json</p>
<pre class="bg-dark text-light p-3 rounded small">{
  "type": "filesystem",
  "description": "Batch request files",
  "enabled": true,
  <span class="text-warning">"broker": "dev-filesystem"</span>,
  "destinations": [
    { "name": "requests",
      "type": "directory" }
  ]
}</pre>
                    </div>
                </div>

                <!-- Layer 3: Ingester -->
                <h5 class="mt-4 border-bottom pb-2"><span class="badge bg-info me-2">Layer 3</span>Ingester — Wiring &amp; Overrides</h5>
                <p>Ingesters wire an input channel to the execution engine. The config is minimal — just an <code>input_channel</code>
                    reference and optional <code>overrides</code> for ingester-specific settings.</p>

                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <p class="fw-bold mb-1">config/ingesters/kafka-requests.json</p>
<pre class="bg-dark text-light p-3 rounded small">{
  "enabled": true,
  "description": "Kafka request ingestion",
  <span class="text-warning">"input_channel": "kafka-requests"</span>,
  "overrides": {
    "group_id": "dgfacade-ingester-kafka"
  }
}</pre>
                    </div>
                    <div class="col-md-4">
                        <p class="fw-bold mb-1">config/ingesters/activemq-requests.json</p>
<pre class="bg-dark text-light p-3 rounded small">{
  "enabled": true,
  "description": "ActiveMQ request ingestion",
  <span class="text-warning">"input_channel": "activemq-requests"</span>
}</pre>
                    </div>
                    <div class="col-md-4">
                        <p class="fw-bold mb-1">config/ingesters/filesystem-batch.json</p>
<pre class="bg-dark text-light p-3 rounded small">{
  "enabled": true,
  "description": "FileSystem batch ingestion",
  <span class="text-warning">"input_channel": "batch-requests"</span>
}</pre>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table dg-table table-bordered table-sm" data-no-search="true">
                        <thead class="table-light">
                            <tr><th>Ingester Field</th><th>Type</th><th>Required</th><th>Description</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><code>enabled</code></td><td>boolean</td><td>No</td><td>Default <code>true</code>. Set <code>false</code> to skip at startup.</td></tr>
                            <tr><td><code>description</code></td><td>string</td><td>No</td><td>Human-readable label for monitoring UI.</td></tr>
                            <tr><td><code>input_channel</code></td><td>string</td><td><span class="badge bg-danger">Yes</span></td><td>Name of an input channel in <code>config/input-channels/</code>. Determines broker, type, and destinations.</td></tr>
                            <tr><td><code>overrides</code></td><td>object</td><td>No</td><td>Key-value pairs that override broker-level settings. Common: <code>group_id</code> (Kafka), <code>poll_interval_seconds</code> (FS).</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="alert alert-info border-0 mt-3 mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Resolution priority:</strong> ingester overrides → broker connection → defaults.
                    For example, if the broker defines <code>group_id: "dgfacade-consumer-group"</code> but the ingester
                    overrides it with <code>group_id: "dgfacade-ingester-kafka"</code>, the ingester value wins.
                </div>
            </div>
        </div>

        <!-- Section 5: Request JSON Format -->
        <div class="card border-0 shadow-sm mb-4" id="request-format">
            <div class="card-header bg-white border-0 py-3">
                <h4 class="mb-0"><span class="badge bg-primary me-2">5</span>Request JSON Format</h4>
            </div>
            <div class="card-body">
                <p>The DGRequest JSON is identical across all ingestion paths:</p>
<pre class="bg-dark text-light p-3 rounded small">{
  <span class="text-success">"api_key"</span>:              <span class="text-warning">"dgf-admin-key-0001"</span>,        <span class="text-info">// Required — API key for authentication</span>
  <span class="text-success">"request_type"</span>:          <span class="text-warning">"ECHO"</span>,                      <span class="text-info">// Required — maps to handler config</span>
  <span class="text-success">"request_id"</span>:            <span class="text-warning">"ord-20250210-001"</span>,          <span class="text-info">// Optional — auto-generated UUID if absent</span>
  <span class="text-success">"payload"</span>: {                                          <span class="text-info">// Required — handler-specific data</span>
    "message": "Hello from Kafka",
    "priority": "HIGH"
  },
  <span class="text-success">"delivery_destination"</span>: <span class="text-warning">"kafka://responses"</span>,         <span class="text-info">// Optional — where to publish result</span>
  <span class="text-success">"ttl_minutes"</span>:           <span class="text-warning">5</span>                             <span class="text-info">// Optional — timeout, default 30</span>
}</pre>
                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <h6><i class="fas fa-key text-primary me-1"></i>Validation</h6>
                                <p class="small mb-0">Every ingester validates two required fields before submitting to the engine:
                                    <code>api_key</code> (non-blank) and <code>request_type</code> (non-blank).
                                    Requests missing either field are <strong>rejected</strong> and counted in the <code>rejected</code> metric.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <h6><i class="fas fa-magic text-success me-1"></i>Auto-Enrichment</h6>
                                <p class="small mb-0">Before submission, the ingester enriches each request:
                                    <code>request_id</code> (UUID if absent), <code>sourceChannel</code> (KAFKA, ACTIVEMQ, or FILESYSTEM),
                                    <code>receivedAt</code> (current timestamp).</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 6: Ingester Lifecycle -->
        <div class="card border-0 shadow-sm mb-4" id="lifecycle">
            <div class="card-header bg-white border-0 py-3">
                <h4 class="mb-0"><span class="badge bg-primary me-2">6</span>Ingester Lifecycle</h4>
            </div>
            <div class="card-body">
<pre class="bg-dark text-light p-3 rounded small" style="line-height: 1.6;">
  <span class="text-success">Spring Boot Startup</span>
        │
        ▼
  <span class="text-info">Phase 9: Request Ingestion Startup</span>
        │
        ├── IngestionService scans <span class="text-warning">config/ingesters/*.json</span>
        │
        ├── For each enabled config:
        │     ├── Create ingester (Kafka / ActiveMQ / FileSystem)
        │     ├── Call <span class="text-warning">initialize(id, config)</span>
        │     ├── Inject ExecutionEngine reference
        │     └── Call <span class="text-warning">start()</span>  →  launches dedicated listener thread
        │
        ├── Log: "<span class="text-success">N ingester(s) started</span>"
        │
        ▼
  <span class="text-success">System Running</span> — all ingesters actively consuming
        │
  <span class="text-danger">Shutdown Signal</span>
        │
        ▼
  <span class="text-info">Shutdown Phase 2: Stop Request Ingesters</span>
        │
        ├── IngestionService calls <span class="text-warning">stopAll()</span>
        │     ├── Kafka: close consumer, shutdown poll executor
        │     ├── ActiveMQ: close JMS consumers, session, connection
        │     └── FileSystem: shutdown scheduled executor
        │
        └── Log final stats per ingester
</pre>
            </div>
        </div>

        <!-- Section 7: Processing Flow -->
        <div class="card border-0 shadow-sm mb-4" id="processing-flow">
            <div class="card-header bg-white border-0 py-3">
                <h4 class="mb-0"><span class="badge bg-primary me-2">7</span>Processing Flow</h4>
            </div>
            <div class="card-body">
                <h5>Kafka Ingester</h5>
<pre class="bg-dark text-light p-3 rounded small">Thread: ingester-kafka-{id}
  └── while (running):
        ├── consumer.poll(500ms)
        ├── for each ConsumerRecord:
        │     ├── Extract record.value() as JSON string
        │     ├── processMessage(json, "topic=X partition=P offset=O")
        │     │     ├── Deserialize JSON → DGRequest
        │     │     ├── Validate api_key, request_type
        │     │     ├── Enrich: sourceChannel=KAFKA, receivedAt=now
        │     │     └── executionEngine.submit(request)
        │     │           └── → HandlerActor → Handler.process()
        │     └── Stats: received++, submitted++ or failed++ or rejected++
        └── On error: log, sleep 2s, retry</pre>

                <h5 class="mt-4">ActiveMQ Ingester</h5>
<pre class="bg-dark text-light p-3 rounded small">JMS Connection → Session → N MessageConsumers (one per destination)
  └── onMessage(Message):
        ├── Cast to TextMessage
        ├── Extract getText() as JSON string
        ├── processMessage(json, "jms:{destination}")
        │     ├── Deserialize JSON → DGRequest
        │     ├── Validate, enrich, submit
        │     └── executionEngine.submit(request)
        └── Non-TextMessage → rejected++, logged as warning</pre>

                <h5 class="mt-4">FileSystem Ingester</h5>
<pre class="bg-dark text-light p-3 rounded small">ScheduledExecutor: every {poll_interval_seconds}s
  └── pollDirectory():
        ├── List files matching pattern in watch_dir
        ├── Sort by lastModifiedTime ASC <span class="text-warning">(oldest first = chronological)</span>
        ├── Limit to max_files_per_poll
        ├── for each file:
        │     ├── Read file content as JSON string
        │     ├── processMessage(json, "file:{filename}")
        │     │     ├── Deserialize, validate, enrich, submit
        │     │     └── executionEngine.submit(request)
        │     ├── Move file → processed/{filename}
        │     │     └── If exists: append timestamp suffix
        │     └── On error: move file → error/{filename}
        └── Empty dir: no-op (silent)</pre>
            </div>
        </div>

        <!-- Section 8: Error Handling -->
        <div class="card border-0 shadow-sm mb-4" id="error-handling">
            <div class="card-header bg-white border-0 py-3">
                <h4 class="mb-0"><span class="badge bg-primary me-2">8</span>Error Handling</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table dg-table table-bordered" data-no-search="true">
                        <thead class="table-light">
                            <tr><th>Error Type</th><th>Counter</th><th>Kafka</th><th>ActiveMQ</th><th>FileSystem</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Malformed JSON</strong></td><td><code>rejected</code></td>
                                <td>Logged as WARN, offset committed (skipped)</td>
                                <td>Logged as WARN, message acknowledged</td>
                                <td>File moved to <code>error/</code> directory</td>
                            </tr>
                            <tr>
                                <td><strong>Missing required fields</strong></td><td><code>rejected</code></td>
                                <td>Logged as WARN, offset committed</td>
                                <td>Logged as WARN, message acknowledged</td>
                                <td>File moved to <code>error/</code> directory</td>
                            </tr>
                            <tr>
                                <td><strong>Handler execution error</strong></td><td><code>failed</code></td>
                                <td colspan="3">DGResponse with status ERROR returned. Logged at ERROR level. Ingester continues processing next message.</td>
                            </tr>
                            <tr>
                                <td><strong>Handler timeout (TTL)</strong></td><td><code>failed</code></td>
                                <td colspan="3">CompletableFuture times out. Logged at ERROR. Does not block ingester.</td>
                            </tr>
                            <tr>
                                <td><strong>Connection loss</strong></td><td>—</td>
                                <td>Poll loop catches exception, sleeps 2s, retries</td>
                                <td>JMS ExceptionListener logs error; broker handles reconnect</td>
                                <td>N/A (local filesystem)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Section 9: Monitoring -->
        <div class="card border-0 shadow-sm mb-4" id="monitoring">
            <div class="card-header bg-white border-0 py-3">
                <h4 class="mb-0"><span class="badge bg-primary me-2">9</span>Monitoring &amp; Stats</h4>
            </div>
            <div class="card-body">
                <p>The <a th:href="@{/monitoring/ingestion}">Ingestion Dashboard</a> shows real-time statistics for all ingesters.</p>
                <p>Each ingester tracks these counters:</p>
                <div class="table-responsive">
                    <table class="table dg-table table-bordered table-sm" data-no-search="true" data-no-sort="true">
                        <thead class="table-light">
                            <tr><th>Metric</th><th>Description</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><code>requestsReceived</code></td><td>Total messages/files read from source (including malformed)</td></tr>
                            <tr><td><code>requestsSubmitted</code></td><td>Successfully submitted to ExecutionEngine and handler completed (SUCCESS or ERROR)</td></tr>
                            <tr><td><code>requestsFailed</code></td><td>Submitted but handler threw exception or timed out</td></tr>
                            <tr><td><code>requestsRejected</code></td><td>Rejected before submission (malformed JSON, missing api_key/request_type)</td></tr>
                            <tr><td><code>startedAt</code></td><td>When the ingester was started</td></tr>
                            <tr><td><code>lastActivityAt</code></td><td>Timestamp of most recent message received</td></tr>
                        </tbody>
                    </table>
                </div>
                <h5 class="mt-3">REST API</h5>
<pre class="bg-dark text-light p-3 rounded small"># List all ingesters with stats
GET /api/v1/ingesters

# Get stats for a specific ingester
GET /api/v1/ingesters/{id}/stats

# Submit a manual request through an ingester
POST /api/v1/ingesters/{id}/submit
Content-Type: application/json
{
  "api_key": "dgf-admin-key-0001",
  "request_type": "ECHO",
  "payload": { "message": "test" }
}</pre>
            </div>
        </div>

        <!-- Section 10: Manual Testing -->
        <div class="card border-0 shadow-sm mb-4" id="manual-testing">
            <div class="card-header bg-white border-0 py-3">
                <h4 class="mb-0"><span class="badge bg-primary me-2">10</span>Manual Testing</h4>
            </div>
            <div class="card-body">
                <p>The <a th:href="@{/monitoring/ingestion}">Ingestion page</a> includes a manual submission form.
                    Select any running ingester, enter request JSON, and submit. The request goes through the full
                    ingester pipeline (deserialization → validation → enrichment → engine submission).</p>
                <h5 class="mt-3">FileSystem Testing</h5>
                <p>Drop a JSON file into the watched directory:</p>
<pre class="bg-dark text-light p-3 rounded small"># Create a request file
echo '{
  "api_key": "dgf-admin-key-0001",
  "request_type": "ECHO",
  "payload": { "message": "File-based request", "batch": true }
}' > ./data/ingest/requests/order-001.json

# The filesystem ingester will pick it up on the next poll cycle
# Check: ls ./data/ingest/processed/   ← file should appear here after processing</pre>

                <h5 class="mt-3">Kafka Testing</h5>
<pre class="bg-dark text-light p-3 rounded small"># Produce a test message to the ingestion topic
kafka-console-producer --broker-list localhost:9092 --topic dgfacade.requests
> {"api_key":"dgf-admin-key-0001","request_type":"HASH","payload":{"algorithm":"SHA-256","input":"test"}}</pre>

                <h5 class="mt-3">ActiveMQ Testing</h5>
<pre class="bg-dark text-light p-3 rounded small"># Using the ActiveMQ web console: http://localhost:8161/admin/send.jsp
# Queue: DGFACADE.REQUESTS
# Message body:
{"api_key":"dgf-admin-key-0001","request_type":"SYSTEM_INFO","payload":{}}</pre>
            </div>
        </div>

        <!-- Section 11: Complete Examples -->
        <div class="card border-0 shadow-sm mb-4" id="examples">
            <div class="card-header bg-white border-0 py-3">
                <h4 class="mb-0"><span class="badge bg-primary me-2">11</span>Complete Examples</h4>
            </div>
            <div class="card-body">
                <h5>Multi-Ingester Production Setup</h5>
                <p>Run three ingesters concurrently — each referencing its own input channel and broker:</p>
<pre class="bg-dark text-light p-3 rounded small"><span class="text-warning">config/brokers/</span>                      <span class="text-success">config/input-channels/</span>              <span class="text-info">config/ingesters/</span>
├── prod-kafka.json               ├── kafka-realtime.json            ├── kafka-realtime.json
├── prod-activemq.json            ├── amq-enterprise.json            ├── activemq-enterprise.json
└── prod-filesystem.json          └── fs-batch-nightly.json          └── fs-batch-nightly.json</pre>

                <h5 class="mt-4">Broker: config/brokers/prod-kafka.json</h5>
<pre class="bg-dark text-light p-3 rounded small">{
  "type": "kafka",
  "description": "Production Kafka cluster with SASL_SSL",
  "enabled": true,
  "connection": {
    "bootstrap_servers": "kafka-prod-1:9092,kafka-prod-2:9092,kafka-prod-3:9092",
    "group_id": "dgfacade-prod",
    "auto_offset_reset": "latest",
    "max_poll_records": 500
  },
  "properties": {
    "security.protocol": "SASL_SSL",
    "sasl.mechanism": "SCRAM-SHA-256",
    "sasl.jaas.config": "...ScramLoginModule required username=\"dgfacade\" password=\"${KAFKA_PASSWORD}\";"
  }
}</pre>

                <h5 class="mt-4">Input Channel: config/input-channels/kafka-realtime.json</h5>
<pre class="bg-dark text-light p-3 rounded small">{
  "type": "kafka",
  "description": "Real-time order events",
  "enabled": true,
  <span class="text-warning">"broker": "prod-kafka"</span>,
  "destinations": [
    { "name": "orders.created", "type": "topic" },
    { "name": "orders.updated", "type": "topic" },
    { "name": "payments.processed", "type": "topic" }
  ]
}</pre>

                <h5 class="mt-4">Ingester: config/ingesters/kafka-realtime.json</h5>
<pre class="bg-dark text-light p-3 rounded small">{
  "enabled": true,
  "description": "Real-time order events from production Kafka cluster",
  <span class="text-warning">"input_channel": "kafka-realtime"</span>,
  "overrides": {
    "group_id": "dgfacade-prod-orders"
  }
}</pre>

                <hr class="my-4">

                <h5>ActiveMQ Enterprise: Broker → Channel → Ingester</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <p class="fw-bold small mb-1">Broker: prod-activemq.json</p>
<pre class="bg-dark text-light p-3 rounded small">{
  "type": "activemq",
  "connection": {
    "broker_url": "failover:(tcp://amq-1:61616,tcp://amq-2:61616)",
    "username": "dgfacade_svc",
    "password": "${AMQ_PASSWORD}"
  }
}</pre>
                    </div>
                    <div class="col-md-4">
                        <p class="fw-bold small mb-1">Channel: amq-enterprise.json</p>
<pre class="bg-dark text-light p-3 rounded small">{
  "type": "jms",
  <span class="text-warning">"broker": "prod-activemq"</span>,
  "destinations": [
    { "name": "TRADE.EXECUTIONS", "type": "queue" },
    { "name": "MARKET.DATA", "type": "topic" }
  ]
}</pre>
                    </div>
                    <div class="col-md-4">
                        <p class="fw-bold small mb-1">Ingester: activemq-enterprise.json</p>
<pre class="bg-dark text-light p-3 rounded small">{
  "enabled": true,
  "description": "Enterprise trade queue",
  <span class="text-warning">"input_channel": "amq-enterprise"</span>
}</pre>
                    </div>
                </div>

                <hr class="my-4">

                <h5>FileSystem Nightly Batch: Broker → Channel → Ingester</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <p class="fw-bold small mb-1">Broker: prod-filesystem.json</p>
<pre class="bg-dark text-light p-3 rounded small">{
  "type": "filesystem",
  "connection": {
    "base_dir": "/data/shared/dgfacade",
    "file_pattern": "batch-*.json",
    "poll_interval_seconds": 30,
    "max_files_per_poll": 500
  }
}</pre>
                    </div>
                    <div class="col-md-4">
                        <p class="fw-bold small mb-1">Channel: fs-batch-nightly.json</p>
<pre class="bg-dark text-light p-3 rounded small">{
  "type": "filesystem",
  <span class="text-warning">"broker": "prod-filesystem"</span>,
  "destinations": [
    { "name": "incoming", "type": "directory" }
  ]
}</pre>
                    </div>
                    <div class="col-md-4">
                        <p class="fw-bold small mb-1">Ingester: fs-batch-nightly.json</p>
<pre class="bg-dark text-light p-3 rounded small">{
  "enabled": true,
  "description": "Nightly batch ETL files",
  <span class="text-warning">"input_channel": "fs-batch-nightly"</span>
}</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 12: Troubleshooting -->
        <div class="card border-0 shadow-sm mb-4" id="troubleshooting">
            <div class="card-header bg-white border-0 py-3">
                <h4 class="mb-0"><span class="badge bg-primary me-2">12</span>Troubleshooting</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table dg-table table-bordered" data-no-search="true">
                        <thead class="table-light">
                            <tr><th style="width: 30%">Symptom</th><th>Cause</th><th>Fix</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Ingester shows "Stopped" but <code>enabled: true</code></td>
                                <td>Connection to broker failed at startup</td>
                                <td>Check broker connectivity. Review log for startup errors. Restart application.</td></tr>
                            <tr><td>Files remain in watch directory</td>
                                <td>File permissions or glob pattern mismatch</td>
                                <td>Verify <code>file_pattern</code> matches file extensions. Check directory write permissions for processed/error dirs.</td></tr>
                            <tr><td>High <code>rejected</code> count</td>
                                <td>Malformed JSON or missing api_key/request_type</td>
                                <td>Validate upstream message format. Check <code>error/</code> dir for filesystem. Review WARN logs.</td></tr>
                            <tr><td>High <code>failed</code> count</td>
                                <td>Handler execution errors or timeouts</td>
                                <td>Check handler configuration. Increase <code>ttl_minutes</code> for long-running handlers. Review handler logs.</td></tr>
                            <tr><td>Kafka consumer lag growing</td>
                                <td>Handler processing slower than ingestion rate</td>
                                <td>Scale horizontally (multiple DGFacade instances with same consumer group). Increase <code>max_poll_records</code>.</td></tr>
                            <tr><td>Duplicate processing</td>
                                <td>Consumer rebalance or restart</td>
                                <td>Use idempotent handlers. Set unique <code>request_id</code> in messages for deduplication.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</main>
<footer th:replace="~{fragments/layout :: footer}"></footer>
<th:block th:replace="~{fragments/layout :: scripts}"></th:block>
</body>
</html>
