<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/layout :: head('Cluster Monitoring')}"></head>
<body class="d-flex flex-column min-vh-100">
<nav th:replace="~{fragments/layout :: navbar}"></nav>
<main class="flex-fill">
<div th:replace="~{fragments/layout :: alerts}"></div>
<div class="container-fluid py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-network-wired me-2" style="color:var(--dg-primary);"></i>Cluster Monitoring</h2>
            <p class="text-muted mb-0">
                Mode: <span class="badge" th:classappend="${clusterEnabled} ? 'bg-primary' : 'bg-secondary'"
                           th:text="${clusterEnabled} ? 'CLUSTER' : 'STANDALONE'">STANDALONE</span>
                &nbsp;|&nbsp; Node ID: <code th:text="${selfNode.nodeId}">node-abc123</code>
                &nbsp;|&nbsp; Role: <span class="badge bg-info" th:text="${selfNode.role}">BOTH</span>
            </p>
        </div>
        <div>
            <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">
                <i class="fas fa-sync-alt me-1"></i> Refresh
            </button>
            <a th:href="@{/help/clustering}" class="btn btn-outline-secondary btn-sm ms-2">
                <i class="fas fa-book me-1"></i> Guide
            </a>
        </div>
    </div>

    <!-- Summary Metrics Row -->
    <div class="row g-3 mb-4">
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body py-3">
                    <div style="font-size:1.8rem;font-weight:800;color:var(--dg-primary);" th:text="${clusterSize}">1</div>
                    <div class="small text-muted" style="text-transform:uppercase;letter-spacing:0.05em;font-size:0.7rem;">Total Nodes</div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body py-3">
                    <div style="font-size:1.8rem;font-weight:800;color:var(--dg-success);" th:text="${statusCounts['UP'] ?: 0}">1</div>
                    <div class="small text-muted" style="text-transform:uppercase;letter-spacing:0.05em;font-size:0.7rem;">Nodes UP</div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body py-3">
                    <div style="font-size:1.8rem;font-weight:800;color:var(--dg-warning);" th:text="${statusCounts['SUSPECT'] ?: 0}">0</div>
                    <div class="small text-muted" style="text-transform:uppercase;letter-spacing:0.05em;font-size:0.7rem;">Suspect</div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body py-3">
                    <div style="font-size:1.8rem;font-weight:800;color:var(--dg-danger);" th:text="${statusCounts['DOWN'] ?: 0}">0</div>
                    <div class="small text-muted" style="text-transform:uppercase;letter-spacing:0.05em;font-size:0.7rem;">Down</div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body py-3">
                    <div style="font-size:1.8rem;font-weight:800;color:var(--dg-info);" th:text="${requestsForwarded}">0</div>
                    <div class="small text-muted" style="text-transform:uppercase;letter-spacing:0.05em;font-size:0.7rem;">Forwarded</div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body py-3">
                    <div style="font-size:1.8rem;font-weight:800;color:var(--dg-info);" th:text="${requestsReceived}">0</div>
                    <div class="small text-muted" style="text-transform:uppercase;letter-spacing:0.05em;font-size:0.7rem;">Received</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Standalone Info -->
    <div th:if="${!clusterEnabled}" class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Standalone Mode</strong> — This node is operating independently. All handler execution is local.
        To enable clustering, set <code>dgfacade.cluster.seed-nodes</code> in <code>application.properties</code>
        to a comma-separated list of peer node URLs (e.g. <code>http://node2:8090,http://node3:8090</code>).
        See <a th:href="@{/help/clustering}">Clustering Guide</a> for details.
    </div>

    <!-- Node Cards -->
    <h4 class="mb-3"><i class="fas fa-server me-2" style="color:var(--dg-primary);"></i>Cluster Nodes</h4>
    <div class="row g-3">
        <div th:each="node : ${allNodes}" class="col-lg-6 col-xl-4">
            <div class="card"
                 th:style="${node.status.name() == 'UP' ? 'border-left:4px solid var(--dg-success)' : (node.status.name() == 'SUSPECT' ? 'border-left:4px solid var(--dg-warning)' : (node.status.name() == 'DOWN' ? 'border-left:4px solid var(--dg-danger)' : 'border-left:4px solid var(--dg-border)'))}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-server me-1"></i>
                        <strong th:text="${node.nodeId}">node-abc123</strong>
                        <span th:if="${node.nodeId == selfNode.nodeId}" class="badge bg-primary ms-1">THIS NODE</span>
                    </div>
                    <div>
                        <span class="badge"
                              th:classappend="${node.role.name() == 'GATEWAY'} ? 'bg-warning' : (${node.role.name() == 'EXECUTOR'} ? 'bg-success' : 'bg-info')"
                              th:text="${node.role}">BOTH</span>
                        <span class="badge"
                              th:classappend="${node.status.name() == 'UP'} ? 'bg-success' : (${node.status.name() == 'SUSPECT'} ? 'bg-warning' : (${node.status.name() == 'DOWN'} ? 'bg-danger' : 'bg-secondary'))"
                              th:text="${node.status}">UP</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-6">
                            <small class="text-muted">Host</small><br/>
                            <code th:text="${node.host + ':' + node.port}">localhost:8090</code>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Version</small><br/>
                            <span th:text="${node.version}">1.6.1</span>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-4">
                            <small class="text-muted">Active Handlers</small><br/>
                            <strong th:text="${node.activeHandlers}">0</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Requests</small><br/>
                            <strong th:text="${node.totalRequestsProcessed}">0</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">CPU Load</small><br/>
                            <strong th:text="${#numbers.formatDecimal(node.cpuLoad, 1, 2)}">0.0</strong>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Heap</small><br/>
                            <span th:text="${node.heapUsedMb + ' / ' + node.heapMaxMb + ' MB'}">128 / 512 MB</span>
                            <div class="progress mt-1" style="height: 6px;">
                                <div class="progress-bar"
                                     th:style="${'width: ' + (node.heapMaxMb > 0 ? (node.heapUsedMb * 100 / node.heapMaxMb) : 0) + '%'}"
                                     th:classappend="${node.heapMaxMb > 0 and (node.heapUsedMb * 100 / node.heapMaxMb > 80)} ? 'bg-danger' : 'bg-success'">
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Started</small><br/>
                            <span th:text="${#temporals.format(node.startedAt, 'MMM dd HH:mm')}">Jan 01 00:00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cluster Configuration Reference -->
    <div class="card mt-4">
        <div class="card-header"><i class="fas fa-cog me-2" style="color:var(--dg-primary);"></i>Cluster Configuration Reference</div>
        <div class="card-body">
            <pre style="background:var(--dg-bg-code);color:var(--dg-text-primary);padding:1rem;border:1px solid var(--dg-border);border-radius:8px;max-height:200px;overflow-y:auto;font-size:0.8rem;">
# application.properties — Cluster Settings

# Standalone mode (default — leave empty):
dgfacade.cluster.seed-nodes=

# Cluster mode — list peer URLs:
dgfacade.cluster.seed-nodes=http://node2:8090,http://node3:8090

# Node role: BOTH (default), GATEWAY, or EXECUTOR
dgfacade.cluster.node-role=BOTH

# Heartbeat interval in seconds (default 15)
dgfacade.cluster.heartbeat-seconds=15</pre>
            <p class="text-muted mt-2 mb-0">
                <i class="fas fa-info-circle me-1"></i>
                Nodes discover each other via seed nodes. A node with role GATEWAY forwards execution to EXECUTOR peers.
                Role BOTH (default) handles both ingestion and execution — ideal for standalone and small clusters.
            </p>
        </div>
    </div>

    <!-- Cluster API Endpoints -->
    <div class="card mt-4">
        <div class="card-header"><i class="fas fa-plug me-2" style="color:var(--dg-primary);"></i>Cluster API Endpoints</div>
        <div class="card-body">
            <table class="table dg-table table-sm mb-0">
                <thead>
                    <tr><th>Endpoint</th><th>Method</th><th>Description</th><th>Try</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>/api/v1/cluster/status</code></td>
                        <td><span class="badge bg-success">GET</span></td>
                        <td>Cluster summary: mode, size, node list, forwarded/received counts</td>
                        <td><a href="/api/v1/cluster/status" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-external-link-alt"></i></a></td>
                    </tr>
                    <tr>
                        <td><code>/api/v1/cluster/nodes</code></td>
                        <td><span class="badge bg-success">GET</span></td>
                        <td>All known cluster nodes with metrics</td>
                        <td><a href="/api/v1/cluster/nodes" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-external-link-alt"></i></a></td>
                    </tr>
                    <tr>
                        <td><code>/api/v1/cluster/heartbeat</code></td>
                        <td><span class="badge bg-warning">POST</span></td>
                        <td>Receive heartbeat from peer (used by cluster protocol)</td>
                        <td><span class="text-muted small">internal</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Distributed Execution Summary -->
    <div class="card mt-4 mb-4">
        <div class="card-header"><i class="fas fa-project-diagram me-2" style="color:var(--dg-primary);"></i>Distributed Execution Flow</div>
        <div class="card-body">
            <pre style="background:var(--dg-bg-code);color:var(--dg-text-primary);padding:1rem;border:1px solid var(--dg-border);border-radius:8px;font-size:0.78rem;overflow-x:auto;"><code>  Request arrives → ExecutionEngine.submit()
      │
      ├── Standalone / BOTH role     → Execute locally on this node
      ├── GATEWAY role + CHAIN type  → Execute locally (chain affinity)
      ├── GATEWAY role + healthy peer exists
      │       → Forward via HTTP POST /api/v1/request to peer
      │       → Response tagged with _forwarded_to metadata
      └── GATEWAY role + no peers    → Fallback: execute locally</code></pre>
            <p class="text-muted small mt-2 mb-0">
                CHAIN requests always execute locally for state affinity. All other requests from GATEWAY nodes
                are forwarded to healthy EXECUTOR/BOTH peers via round-robin selection. If forwarding fails,
                execution falls back to local. For full details see the
                <a th:href="@{/help/clustering}">Clustering &amp; Distributed Execution</a> guide.
            </p>
        </div>
    </div>

</div>
</main>

<footer th:replace="~{fragments/layout :: footer}"></footer>
<th:block th:replace="~{fragments/layout :: scripts}"></th:block>
<script>
// Auto-refresh every 30 seconds
setTimeout(function() { location.reload(); }, 30000);
</script>
</body>
</html>
