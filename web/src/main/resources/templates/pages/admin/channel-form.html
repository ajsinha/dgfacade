<!DOCTYPE html>
<!--
  ~ Copyright © 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  ~ Proprietary and confidential. Patent Pending.
  -->
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('Channel Configuration')}"></head>
<body class="d-flex flex-column min-vh-100">
<nav th:replace="~{fragments/layout :: navbar}"></nav>
<main class="flex-fill">
    <div th:replace="~{fragments/layout :: alerts}"></div>
    <div class="container-fluid py-4">

        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2">
                        <li class="breadcrumb-item"><a th:href="@{/admin/channels}">Channels</a></li>
                        <li class="breadcrumb-item active" th:text="${editMode} ? 'Edit: ' + ${channelId} : 'New Channel'">New Channel</li>
                    </ol>
                </nav>
                <h2 class="mb-0">
                    <i class="fas me-2" th:classappend="${editMode} ? 'fa-edit' : 'fa-plus-circle'"></i>
                    <span th:text="${editMode} ? 'Edit Channel' : 'Create New Channel'">Create New Channel</span>
                </h2>
            </div>
            <div class="col-auto">
                <a th:href="@{/admin/channels}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-1"></i>Back to Channels</a>
            </div>
        </div>

        <form th:action="${editMode} ? @{/admin/channels/edit/{id}(id=${channelId})} : @{/admin/channels/create}" method="post">

        <div class="row g-4">
            <!-- ════════════ LEFT COLUMN: Form ════════════ -->
            <div class="col-lg-8">

                <!-- Basic Info -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3"><h5 class="mb-0"><i class="fas fa-tag me-2 text-primary"></i>Basic Information</h5></div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6" th:if="${!editMode}">
                                <label class="form-label fw-semibold">Channel ID <span class="text-danger">*</span></label>
                                <input type="text" name="channelId" class="form-control" required
                                       placeholder="e.g. order-events, trade-queue"
                                       pattern="[a-zA-Z0-9\-_]+" title="Letters, numbers, hyphens, underscores only"
                                       th:value="${channelId}">
                                <div class="form-text">Unique name. Becomes the config filename. Lowercase letters, numbers, hyphens only.</div>
                            </div>
                            <div class="col-md-6" th:if="${editMode}">
                                <label class="form-label fw-semibold">Channel ID</label>
                                <input type="text" class="form-control" disabled th:value="${channelId}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Channel Type <span class="text-danger">*</span></label>
                                <select name="type" class="form-select">
                                    <option value="kafka" th:selected="${channel['type'] == 'kafka'}">Kafka (Topic-based)</option>
                                    <option value="jms" th:selected="${channel['type'] == 'jms'}">JMS (ActiveMQ / IBM MQ Queue)</option>
                                    <option value="amqp" th:selected="${channel['type'] == 'amqp'}">AMQP (RabbitMQ)</option>
                                    <option value="filesystem" th:selected="${channel['type'] == 'filesystem'}">FileSystem (Directory Watch)</option>
                                    <option value="sql" th:selected="${channel['type'] == 'sql'}">SQL (Database Polling)</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label fw-semibold">Description</label>
                                <input type="text" name="description" class="form-control"
                                       placeholder="e.g. Order lifecycle events from Kafka"
                                       th:value="${channel['description']}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Enabled</label>
                                <select name="enabled" class="form-select">
                                    <option value="true" th:selected="${channel['enabled'] == true}">Yes — Enabled</option>
                                    <option value="false" th:selected="${channel['enabled'] == false}">No — Disabled</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Broker Binding -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3"><h5 class="mb-0"><i class="fas fa-link me-2 text-success"></i>Broker Binding</h5></div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Broker <span class="text-danger">*</span></label>
                                <select name="broker" class="form-select">
                                    <option value="">— Select a broker —</option>
                                    <option th:each="bid : ${brokerIds}" th:value="${bid}" th:text="${bid}"
                                            th:selected="${channel['broker'] != null and channel['broker'].toString() == bid}">broker</option>
                                </select>
                                <div class="form-text">
                                    The broker this channel connects through. 
                                    <a th:href="@{/admin/brokers/create}" target="_blank">Create a broker first</a> if none exist.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subscriptions -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3"><h5 class="mb-0"><i class="fas fa-rss me-2 text-warning"></i>Subscriptions</h5></div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label fw-semibold">Topic / Queue Names</label>
                                <input type="text" name="sub_name" class="form-control"
                                       placeholder="e.g. orders.created, orders.updated"
                                       th:value="${channel['subscriptions'] != null} ? ${#strings.listJoin(channel['subscriptions'].![get('name')], ', ')} : ''">
                                <div class="form-text">Comma-separated list. For Kafka: topic names. For JMS: queue/topic names. Example: <code>orders.created, orders.updated</code></div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Subscription Type</label>
                                <select name="sub_type" class="form-select">
                                    <option value="topic" th:selected="${channel['subscriptions'] != null and !channel['subscriptions'].isEmpty() and channel['subscriptions'][0]['type'] == 'topic'}">Topic</option>
                                    <option value="queue" th:selected="${channel['subscriptions'] != null and !channel['subscriptions'].isEmpty() and channel['subscriptions'][0]['type'] == 'queue'}">Queue</option>
                                </select>
                                <div class="form-text">Topic = pub/sub, Queue = point-to-point</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Queue / Backpressure -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3"><h5 class="mb-0"><i class="fas fa-tachometer-alt me-2 text-info"></i>Queue &amp; Backpressure</h5></div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Queue Depth</label>
                                <input type="number" name="queue_depth" class="form-control" min="100" max="1000000"
                                       placeholder="10000"
                                       th:value="${channel['queue'] != null and channel['queue']['depth'] != null} ? ${channel['queue']['depth']} : '10000'">
                                <div class="form-text">Max buffered messages</div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Warning %</label>
                                <input type="number" name="queue_warning_pct" class="form-control" min="1" max="100"
                                       placeholder="70"
                                       th:value="${channel['queue'] != null and channel['queue']['warning_threshold_pct'] != null} ? ${channel['queue']['warning_threshold_pct']} : '70'">
                                <div class="form-text">Alert threshold</div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Critical %</label>
                                <input type="number" name="queue_critical_pct" class="form-control" min="1" max="100"
                                       placeholder="90"
                                       th:value="${channel['queue'] != null and channel['queue']['critical_threshold_pct'] != null} ? ${channel['queue']['critical_threshold_pct']} : '90'">
                                <div class="form-text">Backpressure trigger</div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Drain Resume %</label>
                                <input type="number" name="queue_drain_pct" class="form-control" min="1" max="100"
                                       placeholder="60"
                                       th:value="${channel['queue'] != null and channel['queue']['drain_resume_pct'] != null} ? ${channel['queue']['drain_resume_pct']} : '60'">
                                <div class="form-text">Resume consuming</div>
                            </div>
                        </div>
                        <div class="alert alert-light border mt-3 mb-0 small">
                            <i class="fas fa-info-circle me-1 text-info"></i>
                            When the queue reaches <strong>Critical %</strong>, the channel pauses consumption (backpressure).
                            It resumes when the queue drains below <strong>Drain Resume %</strong>.
                        </div>
                    </div>
                </div>

                <!-- Retry -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3"><h5 class="mb-0"><i class="fas fa-redo me-2 text-danger"></i>Retry Configuration</h5></div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Max Attempts</label>
                                <input type="number" name="retry_max_attempts" class="form-control" min="0" max="100"
                                       placeholder="3"
                                       th:value="${channel['retry'] != null and channel['retry']['max_attempts'] != null} ? ${channel['retry']['max_attempts']} : '3'">
                                <div class="form-text">0 = no retry</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Backoff (ms)</label>
                                <input type="number" name="retry_backoff_ms" class="form-control" min="100" max="300000"
                                       placeholder="1000"
                                       th:value="${channel['retry'] != null and channel['retry']['backoff_ms'] != null} ? ${channel['retry']['backoff_ms']} : '1000'">
                                <div class="form-text">Initial delay before retry</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Backoff Multiplier</label>
                                <input type="text" name="retry_backoff_multiplier" class="form-control"
                                       placeholder="2.0"
                                       th:value="${channel['retry'] != null and channel['retry']['backoff_multiplier'] != null} ? ${channel['retry']['backoff_multiplier']} : '2.0'">
                                <div class="form-text">Exponential: delay × multiplier per attempt</div>
                            </div>
                        </div>
                        <div class="alert alert-light border mt-3 mb-0 small">
                            <i class="fas fa-calculator me-1 text-info"></i>
                            With defaults (3 attempts, 1000ms, 2.0x): retry at 1s, 2s, 4s. Total wait: 7 seconds.
                        </div>
                    </div>
                </div>

                <!-- Submit -->
                <div class="d-flex gap-2 mb-5">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas me-1" th:classappend="${editMode} ? 'fa-save' : 'fa-plus'"></i>
                        <span th:text="${editMode} ? 'Save Changes' : 'Create Channel'">Create Channel</span>
                    </button>
                    <a th:href="@{/admin/channels}" class="btn btn-outline-secondary btn-lg">Cancel</a>
                </div>
            </div>

            <!-- ════════════ RIGHT COLUMN: Help ════════════ -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm mb-4 sticky-top" style="top: 80px">
                    <div class="card-header bg-primary text-white py-3"><h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Channel Configuration Tips</h6></div>
                    <div class="card-body small">
                        <h6 class="fw-bold text-primary">Channel Types</h6>
                        <dl class="mb-3">
                            <dt><code>kafka</code></dt><dd class="text-muted">Subscribe to Kafka topics. Each subscription name is a topic.</dd>
                            <dt><code>jms</code></dt><dd class="text-muted">JMS queues/topics for ActiveMQ or IBM MQ. Set sub type to "queue" for P2P.</dd>
                            <dt><code>amqp</code></dt><dd class="text-muted">RabbitMQ exchanges and queues via AMQP 0-9-1.</dd>
                            <dt><code>filesystem</code></dt><dd class="text-muted">Watch a directory for new files. Subscription name = glob pattern.</dd>
                            <dt><code>sql</code></dt><dd class="text-muted">Poll a database table. Subscription name = table or query.</dd>
                        </dl>

                        <h6 class="fw-bold text-primary">Backpressure</h6>
                        <p class="text-muted">DGFacade uses a three-threshold model to prevent memory exhaustion.
                            When the in-memory queue reaches the critical threshold, the channel pauses
                            consumption from the broker. It resumes when the queue drains below the resume threshold.</p>

                        <h6 class="fw-bold text-primary">Retry Strategy</h6>
                        <p class="text-muted">Failed messages are retried with exponential backoff.
                            After max attempts, the message is logged as permanently failed.
                            Set max_attempts=0 to disable retries.</p>

                        <h6 class="fw-bold text-primary">Multiple Subscriptions</h6>
                        <p class="text-muted">Enter multiple topic/queue names separated by commas.
                            Each will be subscribed to independently.
                            Example: <code>orders.created, orders.updated, orders.canceled</code></p>

                        <h6 class="fw-bold text-primary">Fan-Out Pattern</h6>
                        <p class="text-muted">Create multiple channels bound to the same broker but subscribing to
                            different topics. Each channel has its own queue depth and backpressure settings.</p>

                        <hr>
                        <p class="text-muted mb-0"><i class="fas fa-file-alt me-1"></i>
                            Config files are saved to <code>config/channels/&lt;id&gt;.json</code>.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        </form>
    </div>
</main>
<footer th:replace="~{fragments/layout :: footer}"></footer>
<th:block th:replace="~{fragments/layout :: scripts}"></th:block>
</body>
</html>
