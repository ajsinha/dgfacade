<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('Channels Help')}"></head>
<body class="d-flex flex-column min-vh-100">
<nav th:replace="~{fragments/layout :: navbar}"></nav>
<main class="flex-fill">
    <div class="container-fluid py-4">
        <nav aria-label="breadcrumb"><ol class="breadcrumb mb-2"><li class="breadcrumb-item"><a th:href="@{/help}">Help</a></li><li class="breadcrumb-item active">Channels</li></ol></nav>
        <h2 class="mb-4"><i class="fas fa-exchange-alt me-2"></i>Channels — Input &amp; Output</h2>

        <div class="row g-4">
            <div class="col-lg-8">

                <!-- Overview -->
                <div class="card border-0 shadow-sm mb-4"><div class="card-body">
                    <h4 class="text-primary"><i class="fas fa-book me-2"></i>Overview</h4>
                    <p>DGFacade uses <strong>Channels</strong> to abstract the connection between the platform and external messaging destinations. Channels are divided into two types:</p>
                    <div class="row g-3">
                        <div class="col-md-6"><div class="p-3 border rounded bg-light h-100"><h5><i class="fas fa-sign-in-alt text-success me-2"></i>Input Channel</h5>
                            <p class="mb-1"><strong>Direction:</strong> Inbound (subscribe/consume)</p>
                            <p class="mb-1"><strong>Pattern:</strong> Fan-Out</p>
                            <p class="mb-0 text-muted small">Subscribes to one or more <em>destinations</em> via a broker and delivers consumed messages into DGFacade for handler processing. One channel can listen on many destinations simultaneously.</p></div></div>
                        <div class="col-md-6"><div class="p-3 border rounded bg-light h-100"><h5><i class="fas fa-sign-out-alt text-warning me-2"></i>Output Channel</h5>
                            <p class="mb-1"><strong>Direction:</strong> Outbound (publish/produce)</p>
                            <p class="mb-1"><strong>Pattern:</strong> Fan-In</p>
                            <p class="mb-0 text-muted small">Receives messages from one or more handlers and publishes them to configured <em>destinations</em> via a broker. Multiple sources converge into a single publishing pipeline.</p></div></div>
                    </div>
                </div></div>

                <!-- Destinations -->
                <div class="card border-0 shadow-sm mb-4"><div class="card-body">
                    <h4 class="text-primary"><i class="fas fa-map-marker-alt me-2"></i>Destinations</h4>
                    <p>A <strong>destination</strong> is the target or source of messages. The concept is universal across all broker types but the concrete form varies:</p>
                    <table class="table dg-table table-bordered small"><thead class="table-light"><tr><th>Broker Type</th><th>Destination Type</th><th>Example</th><th>Description</th></tr></thead>
                    <tbody>
                        <tr><td>Kafka</td><td>topic</td><td><code>orders.created</code></td><td>Kafka topic for pub/sub streaming</td></tr>
                        <tr><td>ActiveMQ (JMS)</td><td>queue</td><td><code>TRADE.INPUT</code></td><td>JMS queue for point-to-point messaging</td></tr>
                        <tr><td>ActiveMQ (JMS)</td><td>topic</td><td><code>EVENTS.BROADCAST</code></td><td>JMS topic for publish/subscribe</td></tr>
                        <tr><td>RabbitMQ (AMQP)</td><td>queue</td><td><code>payment.processing</code></td><td>AMQP queue bound to an exchange</td></tr>
                        <tr><td>IBM MQ</td><td>queue</td><td><code>DEV.QUEUE.1</code></td><td>IBM MQ queue</td></tr>
                        <tr><td>FileSystem</td><td>path</td><td><code>/data/inbox/orders</code></td><td>Directory to watch for new files</td></tr>
                        <tr><td>SQL</td><td>table</td><td><code>dg_inbound_messages</code></td><td>Database table to poll for new rows</td></tr>
                    </tbody></table>
                </div></div>

                <!-- Input Channel Detail -->
                <div class="card border-0 shadow-sm mb-4" id="input-channels"><div class="card-body">
                    <h4 class="text-success"><i class="fas fa-sign-in-alt me-2"></i>Input Channels — In Detail</h4>
                    <p>An input channel <strong>subscribes</strong> to destinations and <strong>consumes</strong> messages. It is the primary way external data enters DGFacade.</p>
                    <h5>JSON Configuration Example</h5>
                    <pre class="bg-dark text-light p-3 rounded small">{
  "type": "kafka",
  "description": "Order lifecycle events from Kafka",
  "enabled": true,
  "broker": "dev-kafka",
  "destinations": [
    { "name": "orders.created", "type": "topic" },
    { "name": "orders.updated", "type": "topic" },
    { "name": "orders.cancelled", "type": "topic" }
  ],
  "queue": {
    "depth": 10000,
    "warning_threshold_pct": 70,
    "critical_threshold_pct": 90,
    "drain_resume_pct": 60
  },
  "retry": {
    "max_attempts": 3,
    "backoff_ms": 1000,
    "backoff_multiplier": 2.0
  }
}</pre>
                    <h5>Fan-Out Example</h5>
                    <div class="alert alert-success small">
                        <strong>Scenario:</strong> You have 3 Kafka topics (<code>orders.created</code>, <code>orders.updated</code>, <code>orders.cancelled</code>) and want to process all of them. Instead of creating 3 channels, create a single input channel with 3 destinations. DGFacade subscribes to all 3 simultaneously and routes messages to the appropriate handler based on <code>request_type</code>.
                    </div>
                    <h5>Backpressure Model</h5>
                    <p class="small text-muted">Each input channel has an internal queue. When the queue reaches <strong>critical_threshold_pct</strong>, the channel pauses consumption (stops pulling messages from the broker). When the queue drains below <strong>drain_resume_pct</strong>, consumption resumes. This prevents memory exhaustion during traffic spikes.</p>
                </div></div>

                <!-- Output Channel Detail -->
                <div class="card border-0 shadow-sm mb-4" id="output-channels"><div class="card-body">
                    <h4 class="text-warning"><i class="fas fa-sign-out-alt me-2"></i>Output Channels — In Detail</h4>
                    <p>An output channel <strong>publishes</strong> messages to destinations. Handlers use output channels to send results, events, or transformed data to external systems.</p>
                    <h5>JSON Configuration Example</h5>
                    <pre class="bg-dark text-light p-3 rounded small">{
  "type": "kafka",
  "description": "Publishes order notification messages",
  "enabled": true,
  "broker": "dev-kafka",
  "destinations": [
    { "name": "notifications.orders.confirmed", "type": "topic" },
    { "name": "notifications.orders.shipped", "type": "topic" }
  ],
  "queue": {
    "depth": 5000,
    "warning_threshold_pct": 70,
    "critical_threshold_pct": 90,
    "drain_resume_pct": 60
  },
  "retry": {
    "max_attempts": 5,
    "backoff_ms": 2000,
    "backoff_multiplier": 2.0
  }
}</pre>
                    <h5>Fan-In Example</h5>
                    <div class="alert alert-warning small">
                        <strong>Scenario:</strong> Multiple handlers — <code>OrderConfirmHandler</code>, <code>PaymentHandler</code>, <code>ShippingHandler</code> — all need to send notifications. Instead of each handler managing its own Kafka producer, they all write to a single output channel (<code>order-notifications</code>). The channel handles connection management, retries, and publishing to the configured destinations.
                    </div>
                    <h5>Output Channel in Handler Config</h5>
                    <p class="small text-muted">A handler references an output channel in its configuration:</p>
                    <pre class="bg-dark text-light p-3 rounded small">{
  "request_type": "PROCESS_ORDER",
  "handler_class": "com.example.OrderHandler",
  "config": {
    "output_channel": "order-notifications",
    "output_destination": "notifications.orders.confirmed"
  }
}</pre>
                </div></div>

                <!-- Property Resolution -->
                <div class="card border-0 shadow-sm mb-4" id="property-resolution"><div class="card-body">
                    <h4 class="text-info"><i class="fas fa-cog me-2"></i>Property Placeholder Resolution</h4>
                    <p>All JSON configuration values support <code>${key}</code> placeholders that are resolved at load time using a waterfall:</p>
                    <ol>
                        <li><strong>JVM System Property</strong> — <code>-Dkafka.servers=prod:9092</code></li>
                        <li><strong>application.properties</strong> — <code>kafka.servers=localhost:9092</code></li>
                        <li><strong>Environment Variable</strong> — <code>export kafka_servers=staging:9092</code></li>
                        <li><strong>Inline Default</strong> — <code>${kafka.servers:localhost:9092}</code></li>
                    </ol>
                    <pre class="bg-dark text-light p-3 rounded small">{
  "type": "kafka",
  "broker": "${env:dev-kafka}",
  "destinations": [
    { "name": "${order.topic:orders.created}", "type": "topic" }
  ]
}</pre>
                    <div class="alert alert-danger small"><i class="fas fa-exclamation-triangle me-1"></i><strong>Important:</strong> If a placeholder cannot be resolved through any of the 4 levels, DGFacade logs a detailed error and exits. Use the <code>${key:default}</code> syntax to provide fallback values. Escape literal colons in defaults with <code>\:</code> — e.g. <code>${db.url:jdbc\:postgresql\://localhost/db}</code>.</div>
                </div></div>
            </div>

            <!-- Sidebar TOC -->
            <div class="col-lg-4"><div class="card border-0 shadow-sm sticky-top" style="top:80px">
                <div class="card-header bg-dark text-white py-3"><h6 class="mb-0"><i class="fas fa-list me-2"></i>On This Page</h6></div>
                <div class="list-group list-group-flush">
                    <a href="#input-channels" class="list-group-item list-group-item-action"><i class="fas fa-sign-in-alt text-success me-2"></i>Input Channels</a>
                    <a href="#output-channels" class="list-group-item list-group-item-action"><i class="fas fa-sign-out-alt text-warning me-2"></i>Output Channels</a>
                    <a href="#property-resolution" class="list-group-item list-group-item-action"><i class="fas fa-cog text-info me-2"></i>Property Resolution</a>
                </div>
                <div class="card-body small">
                    <h6 class="fw-bold">Quick Links</h6>
                    <a th:href="@{/admin/input-channels}" class="btn btn-sm btn-outline-success w-100 mb-2"><i class="fas fa-sign-in-alt me-1"></i>Manage Input Channels</a>
                    <a th:href="@{/admin/output-channels}" class="btn btn-sm btn-outline-warning w-100 mb-2"><i class="fas fa-sign-out-alt me-1"></i>Manage Output Channels</a>
                    <a th:href="@{/admin/brokers}" class="btn btn-sm btn-outline-primary w-100"><i class="fas fa-server me-1"></i>Manage Brokers</a>
                </div>
            </div></div>
        </div>
    </div>
</main>
<footer th:replace="~{fragments/layout :: footer}"></footer>
<th:block th:replace="~{fragments/layout :: scripts}"></th:block>
</body>
</html>
