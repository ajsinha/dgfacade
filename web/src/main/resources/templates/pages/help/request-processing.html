<!DOCTYPE html>
<!--
  ~ Copyright © 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  ~ Proprietary and confidential. Patent Pending.
  -->
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('Request Processing')}"></head>
<body class="d-flex flex-column min-vh-100">

<nav th:replace="~{fragments/layout :: navbar}"></nav>

<main class="flex-fill">
    <div class="container-fluid py-4">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/help"><i class="fas fa-book me-1"></i>Help</a></li>
                <li class="breadcrumb-item active">Request Processing</li>
            </ol>
        </nav>
        <div class="row">
            <div class="col-lg-11 mx-auto">
                <h1 class="display-5 mb-4"><i class="fas fa-project-diagram me-3" style="color: #e74c3c;"></i>Request Processing &mdash; End to End</h1>
                <p class="lead">Complete reference for how a request flows through DGFacade: from ingestion on any channel,
                through handler resolution, Pekko actor execution, TTL enforcement, and result delivery.</p>

                <!-- ═══════════════════ TABLE OF CONTENTS ═══════════════════ -->
                <div class="card mb-5 border-0 shadow-sm" style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                    <div class="card-body">
                        <h5 class="mb-3"><i class="fas fa-list me-2"></i>On This Page</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <ol class="mb-0">
                                    <li><a href="#overview">Processing Pipeline Overview</a></li>
                                    <li><a href="#ingestion">Request Ingestion (4 Channels)</a></li>
                                    <li><a href="#normalization">Normalization to DGRequest</a></li>
                                    <li><a href="#auth">API Key Validation &amp; User Resolution</a></li>
                                    <li><a href="#handler-resolution">Handler Resolution</a></li>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <ol start="6" class="mb-0">
                                    <li><a href="#proxy">Dynamic Proxy (Non-DGHandler Classes)</a></li>
                                    <li><a href="#execution">Pekko Actor Execution &amp; TTL</a></li>
                                    <li><a href="#delivery">Result Delivery &amp; Publication</a></li>
                                    <li><a href="#examples">End-to-End Runnable Examples</a></li>
                                    <li><a href="#errors">Error Handling &amp; Edge Cases</a></li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ═══════════════════ 1. OVERVIEW ═══════════════════ -->
                <section id="overview" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-route me-2 text-primary"></i>1. Processing Pipeline Overview</h2>
                    <div class="card bg-dark text-light mb-4">
                        <div class="card-body">
<pre class="mb-0 text-light" style="font-family: 'Courier New', monospace; font-size: 0.85rem;"><code>
  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
  │   REST API   │  │  WebSocket  │  │    Kafka     │  │  ActiveMQ   │
  │  POST /api/  │  │ ws://…/ws/  │  │  Consumer    │  │  Subscriber │
  │  v1/request  │  │  gateway    │  │  (Topic)     │  │  (Queue)    │
  └──────┬───────┘  └──────┬──────┘  └──────┬───────┘  └──────┬──────┘
         │                 │                 │                 │
         └────────┬────────┴────────┬────────┘                 │
                  │                 │                           │
                  ▼                 ▼                           ▼
         ┌────────────────────────────────────────────────────────────┐
         │              NORMALIZE  →  DGRequest                      │
         │  { request_id, request_type, api_key, payload, ttl }      │
         └───────────────────────────┬────────────────────────────────┘
                                     │
                                     ▼
         ┌────────────────────────────────────────────────────────────┐
         │         API KEY VALIDATION  &amp;  USER RESOLUTION            │
         │    UserService.resolveUserFromApiKey(api_key) → userId    │
         └───────────────────────────┬────────────────────────────────┘
                                     │
                                     ▼
         ┌────────────────────────────────────────────────────────────┐
         │              HANDLER CONFIG LOOKUP                        │
         │    HandlerConfigRegistry.findHandler(userId, type)        │
         │    → HandlerConfig { handler_class, config, ttl }         │
         └───────────────────────────┬────────────────────────────────┘
                                     │
                                     ▼
         ┌────────────────────────────────────────────────────────────┐
         │     CLASS LOADING  &amp;  DYNAMIC PROXY (if needed)          │
         │    Class.forName(handler_class)                           │
         │    ┌─ implements DGHandler? → use directly                │
         │    └─ otherwise → wrap with DGHandlerProxy                │
         └───────────────────────────┬────────────────────────────────┘
                                     │
                                     ▼
         ┌────────────────────────────────────────────────────────────┐
         │            PEKKO ACTOR EXECUTION                          │
         │    HandlerSupervisor → spawns HandlerActor                │
         │    ┌─ construct(config)                                   │
         │    ├─ execute(request) ──────── TTL timer armed ─────┐    │
         │    │      │                                          │    │
         │    │      ▼                                          ▼    │
         │    │  DGResponse                              TIMEOUT!    │
         │    │      │                                    stop()     │
         │    │      ▼                                   cleanup()   │
         │    └─ cleanup()                                           │
         └───────────────────────────┬────────────────────────────────┘
                                     │
                                     ▼
         ┌────────────────────────────────────────────────────────────┐
         │              RESULT DELIVERY                              │
         │    ┌─ REST  → HTTP 200 JSON response                     │
         │    ├─ WS    → WebSocket TextMessage(JSON)                │
         │    ├─ Kafka → Publish to delivery_destination topic       │
         │    └─ AMQ   → Publish to delivery_destination queue       │
         └────────────────────────────────────────────────────────────┘
</code></pre>
                        </div>
                    </div>
                </section>

                <!-- ═══════════════════ 2. INGESTION ═══════════════════ -->
                <section id="ingestion" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-inbox me-2 text-success"></i>2. Request Ingestion (4 Channels)</h2>
                    <p>Requests can arrive on any of four channels. Each channel normalizes the request into a <code>DGRequest</code> before submitting to the execution engine.</p>

                    <div class="row g-4">
                        <!-- REST -->
                        <div class="col-md-6">
                            <div class="card h-100 border-primary">
                                <div class="card-header bg-primary text-white"><h6 class="mb-0"><i class="fas fa-globe me-2"></i>REST API</h6></div>
                                <div class="card-body">
                                    <p><strong>Endpoint:</strong> <code>POST /api/v1/request</code></p>
                                    <p><strong>Content-Type:</strong> <code>application/json</code></p>
                                    <p><strong>Handler:</strong> <code>ApiController.submitRequest()</code></p>
                                    <p><strong>Response:</strong> Synchronous HTTP 200 with <code>DGResponse</code> JSON body</p>
<pre class="bg-dark text-light p-2 rounded small"><code>curl -X POST http://localhost:8080/api/v1/request \
  -H "Content-Type: application/json" \
  -d '{
    "request_type": "ECHO",
    "api_key": "dg-api-admin-001",
    "payload": { "message": "hello" }
  }'</code></pre>
                                </div>
                            </div>
                        </div>
                        <!-- WebSocket -->
                        <div class="col-md-6">
                            <div class="card h-100 border-warning">
                                <div class="card-header bg-warning text-dark"><h6 class="mb-0"><i class="fas fa-plug me-2"></i>WebSocket</h6></div>
                                <div class="card-body">
                                    <p><strong>Endpoint:</strong> <code>ws://host:port/ws/gateway</code></p>
                                    <p><strong>Protocol:</strong> JSON text frames</p>
                                    <p><strong>Handler:</strong> <code>DGFacadeWebSocketHandler</code></p>
                                    <p><strong>Response:</strong> Async JSON message on same WebSocket session</p>
<pre class="bg-dark text-light p-2 rounded small"><code>// JavaScript
const ws = new WebSocket("ws://localhost:8080/ws/gateway");
ws.onopen = () =&gt; ws.send(JSON.stringify({
    request_type: "ARITHMETIC",
    api_key: "dg-api-admin-001",
    payload: { operation: "ADD", operandA: 10, operandB: 25 }
}));
ws.onmessage = (e) =&gt; console.log(JSON.parse(e.data));</code></pre>
                                </div>
                            </div>
                        </div>
                        <!-- Kafka -->
                        <div class="col-md-6">
                            <div class="card h-100 border-dark">
                                <div class="card-header bg-dark text-white"><h6 class="mb-0"><i class="fas fa-stream me-2"></i>Kafka</h6></div>
                                <div class="card-body">
                                    <p><strong>Source:</strong> Kafka topic configured in <code>config/channels/*.json</code></p>
                                    <p><strong>Direction:</strong> <code>SUBSCRIBE</code></p>
                                    <p><strong>Format:</strong> JSON <code>DGRequest</code> as message value</p>
                                    <p><strong>Response:</strong> Published to <code>delivery_destination</code> topic (if set) or a default response topic</p>
<pre class="bg-dark text-light p-2 rounded small"><code>// Kafka message value (JSON):
{
  "request_type": "ECHO",
  "api_key": "dg-api-admin-001",
  "payload": { "source": "upstream-system" },
  "delivery_destination": "dgfacade.responses"
}</code></pre>
                                </div>
                            </div>
                        </div>
                        <!-- ActiveMQ -->
                        <div class="col-md-6">
                            <div class="card h-100" style="border-color: #10b981;">
                                <div class="card-header text-white" style="background-color: #10b981;"><h6 class="mb-0"><i class="fas fa-envelope me-2"></i>ActiveMQ / RabbitMQ / IBM MQ</h6></div>
                                <div class="card-body">
                                    <p><strong>Source:</strong> JMS queue or topic configured in <code>config/channels/*.json</code></p>
                                    <p><strong>Direction:</strong> <code>SUBSCRIBE</code></p>
                                    <p><strong>Format:</strong> JMS <code>TextMessage</code> with JSON body</p>
                                    <p><strong>Response:</strong> Published to <code>delivery_destination</code> queue/topic</p>
<pre class="bg-dark text-light p-2 rounded small"><code>// JMS TextMessage body (JSON):
{
  "request_type": "ARITHMETIC",
  "api_key": "dg-api-admin-001",
  "payload": { "operation": "MULTIPLY",
               "operandA": 7, "operandB": 6 },
  "delivery_destination": "queue://DGFACADE.RESULTS"
}</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ═══════════════════ 3. NORMALIZATION ═══════════════════ -->
                <section id="normalization" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-exchange-alt me-2 text-info"></i>3. Normalization to DGRequest</h2>
                    <p>Regardless of source channel, every request is normalized into a <code>DGRequest</code> object:</p>
                    <div class="card mb-3">
                        <div class="card-header"><h6 class="mb-0"><i class="fas fa-file-code me-2"></i>DGRequest JSON Schema</h6></div>
                        <div class="card-body">
<pre class="bg-dark text-light p-3 rounded"><code>{
  "request_id":           "auto-generated UUID (or client-supplied)",
  "request_type":         "ECHO",                          <span class="text-warning">// ← maps to handler</span>
  "api_key":              "dg-api-admin-001",               <span class="text-warning">// ← authentication</span>
  "payload":              { "key": "value", ... },          <span class="text-warning">// ← handler input data</span>
  "delivery_destination": "kafka://responses",              <span class="text-warning">// ← where to send result</span>
  "ttl_minutes":          5                                 <span class="text-warning">// ← max execution time</span>
}</code></pre>
                        </div>
                    </div>
                    <table class="table table-bordered">
                        <thead class="table-dark"><tr><th>Field</th><th>Required</th><th>Description</th></tr></thead>
                        <tbody>
                            <tr><td><code>request_type</code></td><td><span class="badge bg-danger">Yes</span></td><td>Matches the handler config key in <code>config/handlers/*.json</code></td></tr>
                            <tr><td><code>api_key</code></td><td><span class="badge bg-danger">Yes</span></td><td>Resolves to a user. Invalid key → 403 error response.</td></tr>
                            <tr><td><code>payload</code></td><td><span class="badge bg-danger">Yes</span></td><td>Free-form map of key-value pairs passed to the handler</td></tr>
                            <tr><td><code>request_id</code></td><td>No</td><td>Auto-generated UUID if not provided. Used for correlation.</td></tr>
                            <tr><td><code>delivery_destination</code></td><td>No</td><td>Override where the response is published (topic, queue, etc.)</td></tr>
                            <tr><td><code>ttl_minutes</code></td><td>No</td><td>Overrides handler&rsquo;s default TTL. Handler is stopped if exceeded.</td></tr>
                        </tbody>
                    </table>
                    <p>Internal fields set by the server: <code>resolvedUserId</code>, <code>sourceChannel</code> (REST|WebSocket|Kafka|ActiveMQ), <code>receivedAt</code>, <code>executionStartedAt</code>.</p>
                </section>

                <!-- ═══════════════════ 4. AUTH ═══════════════════ -->
                <section id="auth" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-key me-2 text-warning"></i>4. API Key Validation &amp; User Resolution</h2>
<pre class="bg-dark text-light p-3 rounded"><code>// ExecutionEngine.submit()
String userId = userService.resolveUserFromApiKey(request.getApiKey());
if (userId == null) {
    return DGResponse.error(requestId, "Invalid or disabled API key");
}
request.setResolvedUserId(userId);</code></pre>
                    <p class="mt-3">API keys are loaded from <code>config/apikeys.json</code> at startup. Each key maps to a userId. If the key is invalid or the associated user is disabled, the request is rejected immediately without handler instantiation.</p>
                </section>

                <!-- ═══════════════════ 5. HANDLER RESOLUTION ═══════════════════ -->
                <section id="handler-resolution" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-search me-2 text-success"></i>5. Handler Resolution</h2>
                    <p>The <code>HandlerConfigRegistry</code> scans <code>config/handlers/*.json</code> at startup. Each file maps <code>request_type</code> keys to handler class configurations:</p>
<pre class="bg-dark text-light p-3 rounded"><code>// config/handlers/default.json
{
  "ECHO": {
    "handler_class": "com.dgfacade.server.handler.EchoHandler",
    "description": "Echoes back the request payload",
    "ttl_minutes": 5,
    "config": {}
  },
  "ARITHMETIC": {
    "handler_class": "com.dgfacade.server.handler.ArithmeticHandler",
    "description": "Performs arithmetic operations",
    "ttl_minutes": 5,
    "config": { "precision": 10 }
  }
}</code></pre>
                    <p>Resolution: <code>HandlerConfigRegistry.findHandler(userId, requestType)</code> → looks up by <code>request_type</code> string. If no handler is found, an error response is returned immediately.</p>
                </section>

                <!-- ═══════════════════ 6. DYNAMIC PROXY ═══════════════════ -->
                <section id="proxy" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-magic me-2" style="color: #8b5cf6;"></i>6. Dynamic Proxy for Non-DGHandler Classes</h2>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Key Feature:</strong> Handler classes do <em>not</em> need to implement <code>DGHandler</code>.
                        If a class does not implement the interface, DGFacade wraps it automatically using <code>DGHandlerProxy</code>
                        with Java reflection. This enables external JARs and legacy classes to work without any DGFacade dependency.
                    </div>

                    <div class="card bg-dark text-light mb-4">
                        <div class="card-body">
<pre class="mb-0 text-light" style="font-family: 'Courier New', monospace; font-size: 0.85rem;"><code>
  Class.forName("com.example.LegacyProcessor")
      │
      ├─ implements DGHandler?
      │       │
      │       YES → use directly as DGHandler
      │
      └─ NO → wrap in DGHandlerProxy
               │
               ├─ Scans for construct-like methods:
               │     construct(Map), init(Map), initialize(Map), setup(Map)
               │
               ├─ Scans for execute-like methods (priority order):
               │     execute(DGRequest) → DGResponse    ← best match
               │     execute(Map) → Object               ← payload in, result out
               │     process(Map) → Object               ← alternate naming
               │     handle(Map)  → Object               ← alternate naming
               │     run(Map)     → Object               ← alternate naming
               │     call()       → Object               ← no-arg
               │
               ├─ Scans for stop-like methods:
               │     stop(), cancel(), abort(), shutdown()
               │
               └─ Scans for cleanup-like methods:
                     cleanup(), close(), destroy(), dispose()
</code></pre>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card h-100 border-success">
                                <div class="card-header bg-success text-white"><h6 class="mb-0"><i class="fas fa-check me-2"></i>Implements DGHandler (Direct)</h6></div>
                                <div class="card-body">
<pre class="bg-dark text-light p-2 rounded small"><code>public class OrderHandler implements DGHandler {

    private Map&lt;String, Object&gt; config;

    @Override
    public void construct(Map&lt;String, Object&gt; config) {
        this.config = config;
    }

    @Override
    public DGResponse execute(DGRequest request) {
        Map&lt;String, Object&gt; payload = request.getPayload();
        String orderId = (String) payload.get("order_id");
        // ... process order ...
        return DGResponse.success(request.getRequestId(),
            Map.of("order_id", orderId, "status", "CREATED"));
    }

    @Override
    public void stop() { /* cancel */ }

    @Override
    public void cleanup() { /* release */ }
}</code></pre>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100" style="border-color: #8b5cf6;">
                                <div class="card-header text-white" style="background: #8b5cf6;"><h6 class="mb-0"><i class="fas fa-magic me-2"></i>No DGHandler (Dynamic Proxy)</h6></div>
                                <div class="card-body">
<pre class="bg-dark text-light p-2 rounded small"><code>// This class has NO dependency on DGFacade at all!
public class LegacyPaymentProcessor {

    private Map&lt;String, Object&gt; settings;

    // Discovered as → construct()
    public void init(Map&lt;String, Object&gt; config) {
        this.settings = config;
    }

    // Discovered as → execute()
    public Map&lt;String, Object&gt; process(
            Map&lt;String, Object&gt; payload) {
        String txnId = (String) payload.get("txn_id");
        double amount = ((Number)
            payload.get("amount")).doubleValue();
        return Map.of("status", "APPROVED",
            "txn_id", txnId, "amount", amount);
    }

    // Discovered as → cleanup()
    public void close() { /* release resources */ }
}</code></pre>
                                    <div class="alert alert-light mt-2 small mb-0">
                                        <strong>Proxy maps:</strong> <code>init(Map)</code> → construct, <code>process(Map)</code> → execute, <code>close()</code> → cleanup.<br>
                                        Return type <code>Map</code> is automatically wrapped in <code>DGResponse.success()</code>.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h5 class="mt-4">Return Value Handling</h5>
                    <table class="table table-bordered table-sm">
                        <thead class="table-light"><tr><th>Execute Method Returns</th><th>DGResponse Mapping</th></tr></thead>
                        <tbody>
                            <tr><td><code>DGResponse</code></td><td>Used directly</td></tr>
                            <tr><td><code>Map&lt;String, Object&gt;</code></td><td><code>DGResponse.success(requestId, map)</code></td></tr>
                            <tr><td><code>String</code></td><td><code>DGResponse.success(requestId, Map.of("result", string))</code></td></tr>
                            <tr><td><code>Number / Boolean</code></td><td><code>DGResponse.success(requestId, Map.of("result", value))</code></td></tr>
                            <tr><td><code>void / null</code></td><td><code>DGResponse.success(requestId, Map.of("result", "completed"))</code></td></tr>
                            <tr><td>Any other Object</td><td><code>DGResponse.success(requestId, Map.of("result", obj.toString()))</code></td></tr>
                        </tbody>
                    </table>
                </section>

                <!-- ═══════════════════ 7. EXECUTION & TTL ═══════════════════ -->
                <section id="execution" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-cogs me-2 text-danger"></i>7. Pekko Actor Execution &amp; TTL Enforcement</h2>
                    <p>Each request gets its own lightweight Pekko actor (<code>HandlerActor</code>). The actor manages the full handler lifecycle:</p>

                    <div class="card mb-4">
                        <div class="card-header bg-dark text-white"><h6 class="mb-0">Handler Lifecycle Phases</h6></div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col"><span class="badge bg-secondary p-2">QUEUED</span></div>
                                <div class="col-auto align-self-center"><i class="fas fa-arrow-right text-muted"></i></div>
                                <div class="col"><span class="badge bg-info p-2">CONSTRUCTING</span></div>
                                <div class="col-auto align-self-center"><i class="fas fa-arrow-right text-muted"></i></div>
                                <div class="col"><span class="badge bg-primary p-2">EXECUTING</span></div>
                                <div class="col-auto align-self-center"><i class="fas fa-arrow-right text-muted"></i></div>
                                <div class="col"><span class="badge bg-success p-2">COMPLETED</span></div>
                            </div>
                            <div class="row text-center mt-2">
                                <div class="col"></div>
                                <div class="col"></div>
                                <div class="col">
                                    <i class="fas fa-arrow-down text-danger"></i><br>
                                    <span class="badge bg-danger p-2">TIMED_OUT</span> / <span class="badge bg-warning text-dark p-2">FAILED</span>
                                </div>
                                <div class="col"></div>
                            </div>
                        </div>
                    </div>

                    <h5><i class="fas fa-stopwatch me-2 text-danger"></i>TTL (Time To Live) Enforcement</h5>
                    <p>When a handler exceeds its TTL, DGFacade forcibly suspends it:</p>
<pre class="bg-dark text-light p-3 rounded"><code>// HandlerActor — TTL timer is armed when execution starts:
int ttl = handlerConfig.getTtlMinutes();        // from handler JSON config
if (request.getTtlMinutes() > 0)
    ttl = request.getTtlMinutes();              // request can override

getContext().scheduleOnce(Duration.ofMinutes(ttl), self, new Timeout());

// When timeout fires:
private Behavior&lt;Command&gt; onTimeout(Timeout cmd) {
    log.warn("Handler {} TTL expired, forcing stop", handlerId);
    handler.stop();       // ← signal handler to stop gracefully
    handler.cleanup();    // ← release resources
    state.markTimedOut(); // ← phase = TIMED_OUT

    DGResponse timeoutResp = DGResponse.timeout(requestId);
    // → { "status": "TIMEOUT", "error_message": "Request exceeded TTL..." }
    responseFuture.complete(timeoutResp);
    return Behaviors.stopped(); // actor terminates
}</code></pre>
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Handler Suspension on TTL Breach:</strong> The handler&rsquo;s <code>stop()</code> method is called first,
                        giving it a chance to save partial work. Then <code>cleanup()</code> releases resources. The Pekko actor terminates,
                        and a <code>TIMEOUT</code> response is returned to the caller. Well-written handlers should check their <code>stopped</code>
                        flag periodically in long-running loops.
                    </div>
                    <h6>Example: Handler that respects TTL</h6>
<pre class="bg-dark text-light p-3 rounded"><code>public class LongRunningHandler implements DGHandler {
    private volatile boolean stopped = false;

    @Override public void construct(Map&lt;String, Object&gt; config) {}

    @Override
    public DGResponse execute(DGRequest request) {
        for (int i = 0; i &lt; 10000; i++) {
            if (stopped) {   // ← CHECK THIS in every iteration
                return DGResponse.error(request.getRequestId(),
                    "Stopped at iteration " + i + " due to TTL");
            }
            // ... do work ...
            try { Thread.sleep(100); } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            }
        }
        return DGResponse.success(request.getRequestId(), Map.of("iterations", 10000));
    }

    @Override public void stop() { stopped = true; }   // ← called on TTL breach
    @Override public void cleanup() { }
}</code></pre>
                </section>

                <!-- ═══════════════════ 8. DELIVERY ═══════════════════ -->
                <section id="delivery" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-paper-plane me-2" style="color: #06b6d4;"></i>8. Result Delivery &amp; Publication</h2>
                    <p>After handler execution completes (success, error, or timeout), the <code>DGResponse</code> is delivered back through the originating channel or to a specified <code>delivery_destination</code>.</p>

                    <table class="table table-bordered">
                        <thead class="table-dark"><tr><th>Source Channel</th><th>Default Delivery</th><th>With delivery_destination</th></tr></thead>
                        <tbody>
                            <tr><td><strong>REST</strong></td><td>HTTP 200 JSON response body</td><td>Also publishes to specified Kafka/MQ topic</td></tr>
                            <tr><td><strong>WebSocket</strong></td><td>JSON text frame on same session</td><td>Also publishes to specified Kafka/MQ topic</td></tr>
                            <tr><td><strong>Kafka</strong></td><td>Published to configured response topic</td><td>Overrides response topic with destination</td></tr>
                            <tr><td><strong>ActiveMQ/RabbitMQ/IBM MQ</strong></td><td>Published to configured response queue</td><td>Overrides response queue with destination</td></tr>
                        </tbody>
                    </table>

                    <h5 class="mt-3">DGResponse JSON Structure</h5>
<pre class="bg-dark text-light p-3 rounded"><code>{
  "request_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "SUCCESS",                    <span class="text-warning">// SUCCESS | ERROR | TIMEOUT | STREAMING_UPDATE</span>
  "data": {                               <span class="text-warning">// handler output (null on error/timeout)</span>
    "result": 42,
    "operation": "MULTIPLY"
  },
  "error_message": null,                  <span class="text-warning">// null on success</span>
  "handler_id": "hdl-a3b9c2d1e4f5",
  "execution_time_ms": 12,
  "timestamp": "2025-01-15T10:30:00Z"
}</code></pre>
                </section>

                <!-- ═══════════════════ 9. EXAMPLES ═══════════════════ -->
                <section id="examples" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-play-circle me-2 text-primary"></i>9. End-to-End Runnable Examples</h2>
                    <p>These examples use the built-in handlers and can be run directly from the DGFacade UI or command line.</p>

                    <!-- REST Example -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-globe me-2"></i>Example 1: REST API — Arithmetic Handler</h5>
                        </div>
                        <div class="card-body">
                            <h6>Step 1: Send Request (curl)</h6>
<pre class="bg-dark text-light p-3 rounded"><code>curl -s -X POST http://localhost:8080/api/v1/request \
  -H "Content-Type: application/json" \
  -d '{
    "request_type": "ARITHMETIC",
    "api_key": "dg-api-admin-001",
    "payload": {
      "operation": "MULTIPLY",
      "operandA": 7,
      "operandB": 6
    }
  }' | python3 -m json.tool</code></pre>
                            <h6 class="mt-3">Step 2: Response</h6>
<pre class="bg-dark text-light p-3 rounded"><code>{
  "request_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "status": "SUCCESS",
  "data": {
    "operation": "MULTIPLY",
    "operandA": 7.0,
    "operandB": 6.0,
    "result": 42.0
  },
  "handler_id": "hdl-a3b9c2d1e4f5",
  "execution_time_ms": 2,
  "timestamp": "2025-01-15T10:30:00.123Z"
}</code></pre>
                            <h6 class="mt-3">Step 3: Processing Flow</h6>
                            <ol>
                                <li><code>ApiController.submitRequest()</code> receives HTTP POST, deserializes JSON → <code>DGRequest</code></li>
                                <li>Sets <code>sourceChannel = "REST"</code></li>
                                <li><code>ExecutionEngine.submit()</code> validates API key <code>dg-api-admin-001</code> → resolves <code>userId = "admin"</code></li>
                                <li><code>HandlerConfigRegistry.findHandler("admin", "ARITHMETIC")</code> → returns <code>ArithmeticHandler</code> config</li>
                                <li>Pekko <code>HandlerSupervisor</code> spawns <code>HandlerActor</code></li>
                                <li>Actor loads <code>ArithmeticHandler</code> (implements DGHandler → used directly)</li>
                                <li><code>construct(config)</code> → no-op for ArithmeticHandler</li>
                                <li><code>execute(request)</code> → parses <code>MULTIPLY</code>, computes 7 &times; 6 = 42</li>
                                <li><code>cleanup()</code> → no-op</li>
                                <li>Actor completes <code>CompletableFuture&lt;DGResponse&gt;</code></li>
                                <li>REST controller returns HTTP 200 with JSON body</li>
                            </ol>
                        </div>
                    </div>

                    <!-- WebSocket Example -->
                    <div class="card mb-4">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="fas fa-plug me-2"></i>Example 2: WebSocket — Echo Handler (From UI Dashboard)</h5>
                        </div>
                        <div class="card-body">
                            <h6>Step 1: Connect &amp; Send (JavaScript — paste in browser console on Dashboard page)</h6>
<pre class="bg-dark text-light p-3 rounded"><code>// Connect to DGFacade WebSocket
const ws = new WebSocket(
    "ws://" + window.location.host + "/ws/gateway");

ws.onopen = function() {
    console.log("✓ Connected to DGFacade WebSocket");

    // Send an ECHO request
    ws.send(JSON.stringify({
        request_type: "ECHO",
        api_key: "dg-api-admin-001",
        payload: {
            message: "Hello DGFacade!",
            timestamp: new Date().toISOString(),
            nested: { a: 1, b: [2, 3, 4] }
        }
    }));
    console.log("→ Request sent");
};

ws.onmessage = function(event) {
    const response = JSON.parse(event.data);
    console.log("← Response received:");
    console.log("   Status:", response.status);
    console.log("   Handler:", response.handler_id);
    console.log("   Time:", response.execution_time_ms, "ms");
    console.log("   Data:", JSON.stringify(response.data, null, 2));
};

ws.onerror = (e) => console.error("WebSocket error:", e);
ws.onclose = (e) => console.log("WebSocket closed:", e.code);</code></pre>
                            <h6 class="mt-3">Step 2: Expected Console Output</h6>
<pre class="bg-dark text-light p-3 rounded"><code>✓ Connected to DGFacade WebSocket
→ Request sent
← Response received:
   Status: SUCCESS
   Handler: hdl-f7e8d9c0b1a2
   Time: 1 ms
   Data: {
     "echo_payload": { "message": "Hello DGFacade!", "timestamp": "...", "nested": {...} },
     "echo_request_type": "ECHO",
     "echo_request_id": "...",
     "echo_timestamp": "2025-01-15T10:30:00.456Z",
     "handler_config": {}
   }</code></pre>
                        </div>
                    </div>

                    <!-- Kafka Delivery Example -->
                    <div class="card mb-4">
                        <div class="card-header bg-dark text-white">
                            <h5 class="mb-0"><i class="fas fa-stream me-2"></i>Example 3: REST Request → Kafka Result Publication</h5>
                        </div>
                        <div class="card-body">
                            <p>This example sends a request via REST API but routes the result to a Kafka topic using <code>delivery_destination</code>.</p>

                            <h6>Step 1: Handler Config (<code>config/handlers/default.json</code>)</h6>
<pre class="bg-dark text-light p-3 rounded"><code>{
  "ECHO": {
    "handler_class": "com.dgfacade.server.handler.EchoHandler",
    "ttl_minutes": 5,
    "config": {}
  }
}</code></pre>
                            <h6 class="mt-3">Step 2: Broker Config (<code>config/brokers/response-kafka.json</code>)</h6>
<pre class="bg-dark text-light p-3 rounded"><code>{
  "type": "kafka",
  "description": "Kafka cluster for response publication",
  "connection": {
    "bootstrap_servers": "kafka-1:9092,kafka-2:9092",
    "client_id": "dgfacade-response-publisher"
  }
}</code></pre>
                            <h6 class="mt-3">Step 3: Channel Config (<code>config/channels/response-channel.json</code>)</h6>
<pre class="bg-dark text-light p-3 rounded"><code>{
  "channel_name": "kafka-response-out",
  "direction": "PUBLISH",
  "broker_id": "response-kafka",
  "topic_or_queue": "dgfacade.responses",
  "delivery_mode": "EVENT_BASED",
  "enabled": true
}</code></pre>
                            <h6 class="mt-3">Step 4: Send REST Request with Kafka Delivery</h6>
<pre class="bg-dark text-light p-3 rounded"><code>curl -s -X POST http://localhost:8080/api/v1/request \
  -H "Content-Type: application/json" \
  -d '{
    "request_type": "ECHO",
    "api_key": "dg-api-admin-001",
    "payload": { "order_id": "ORD-2025-001", "action": "CONFIRM" },
    "delivery_destination": "dgfacade.responses"
  }' | python3 -m json.tool</code></pre>
                            <h6 class="mt-3">Step 5: Result on Kafka Topic</h6>
<pre class="bg-dark text-light p-3 rounded"><code># Consume from response topic:
kafka-console-consumer --bootstrap-server kafka-1:9092 \
  --topic dgfacade.responses --from-latest

# Output:
{
  "request_id": "...",
  "status": "SUCCESS",
  "data": {
    "echo_payload": { "order_id": "ORD-2025-001", "action": "CONFIRM" },
    "echo_request_type": "ECHO",
    "echo_request_id": "...",
    "echo_timestamp": "2025-01-15T10:32:00Z",
    "handler_config": {}
  },
  "handler_id": "hdl-...",
  "execution_time_ms": 1
}</code></pre>
                        </div>
                    </div>

                    <!-- TTL Breach Example -->
                    <div class="card mb-4">
                        <div class="card-header" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white;">
                            <h5 class="mb-0"><i class="fas fa-stopwatch me-2"></i>Example 4: TTL Breach — Handler Suspension</h5>
                        </div>
                        <div class="card-body">
                            <p>The <code>DELAYED</code> handler simulates long-running work. Set a short TTL to see the timeout mechanism in action.</p>
<pre class="bg-dark text-light p-3 rounded"><code>curl -s -X POST http://localhost:8080/api/v1/request \
  -H "Content-Type: application/json" \
  -d '{
    "request_type": "DELAYED",
    "api_key": "dg-api-admin-001",
    "payload": { "delay_ms": 300000 },
    "ttl_minutes": 1
  }' | python3 -m json.tool</code></pre>
                            <h6 class="mt-3">After 1 minute &mdash; Response:</h6>
<pre class="bg-dark text-light p-3 rounded"><code>{
  "request_id": "...",
  "status": "TIMEOUT",
  "error_message": "Request exceeded TTL and was terminated",
  "handler_id": "hdl-...",
  "execution_time_ms": 60000,
  "timestamp": "2025-01-15T10:31:00Z"
}</code></pre>
                            <p class="mt-2">In the server logs you will see:</p>
<pre class="bg-dark text-light p-3 rounded small"><code>WARN  HandlerActor - Handler hdl-a3b9c2d1e4f5 TTL expired, forcing stop
INFO  HandlerActor - stop() called on DelayedHandler
INFO  HandlerActor - cleanup() called on DelayedHandler
INFO  HandlerActor - Handler actor stopped</code></pre>
                        </div>
                    </div>

                    <!-- Dynamic Proxy Example -->
                    <div class="card mb-4">
                        <div class="card-header" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9); color: white;">
                            <h5 class="mb-0"><i class="fas fa-magic me-2"></i>Example 5: Non-DGHandler Class via Dynamic Proxy</h5>
                        </div>
                        <div class="card-body">
                            <h6>Step 1: External Handler (no DGFacade dependency)</h6>
<pre class="bg-dark text-light p-3 rounded"><code>// com.example.external.WeatherLookup — in an external JAR in libs/
public class WeatherLookup {

    private String defaultCity;

    // Proxy discovers as → construct(Map)
    public void initialize(Map&lt;String, Object&gt; config) {
        this.defaultCity = (String) config.getOrDefault("default_city", "New York");
    }

    // Proxy discovers as → execute(Map) returning Map
    public Map&lt;String, Object&gt; handle(Map&lt;String, Object&gt; payload) {
        String city = (String) payload.getOrDefault("city", defaultCity);
        // Simulate weather lookup
        return Map.of(
            "city", city,
            "temperature_f", 72,
            "condition", "Sunny",
            "humidity_pct", 45
        );
    }

    // Proxy discovers as → cleanup()
    public void dispose() {
        // Release HTTP client, etc.
    }
}</code></pre>
                            <h6 class="mt-3">Step 2: Handler Config</h6>
<pre class="bg-dark text-light p-3 rounded"><code>{
  "WEATHER": {
    "handler_class": "com.example.external.WeatherLookup",
    "ttl_minutes": 2,
    "config": { "default_city": "San Francisco" }
  }
}</code></pre>
                            <h6 class="mt-3">Step 3: Call It</h6>
<pre class="bg-dark text-light p-3 rounded"><code>curl -s -X POST http://localhost:8080/api/v1/request \
  -H "Content-Type: application/json" \
  -d '{
    "request_type": "WEATHER",
    "api_key": "dg-api-admin-001",
    "payload": { "city": "Tokyo" }
  }' | python3 -m json.tool</code></pre>
                            <h6 class="mt-3">Step 4: Response (Map auto-wrapped in DGResponse)</h6>
<pre class="bg-dark text-light p-3 rounded"><code>{
  "request_id": "...",
  "status": "SUCCESS",
  "data": {
    "city": "Tokyo",
    "temperature_f": 72,
    "condition": "Sunny",
    "humidity_pct": 45
  },
  "handler_id": "hdl-...",
  "execution_time_ms": 3
}</code></pre>
                            <p class="mt-2">Server log:</p>
<pre class="bg-dark text-light p-3 rounded small"><code>INFO  DGHandlerProxy - Class WeatherLookup does NOT implement DGHandler — wrapping with dynamic proxy
INFO  DGHandlerProxy - Resolved: construct=initialize(), execute=handle()(MAP_TO_OBJECT), stop=NONE, cleanup=dispose()</code></pre>
                        </div>
                    </div>
                </section>

                <!-- ═══════════════════ 10. ERRORS ═══════════════════ -->
                <section id="errors" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-exclamation-circle me-2 text-danger"></i>10. Error Handling &amp; Edge Cases</h2>
                    <table class="table table-bordered">
                        <thead class="table-dark"><tr><th>Scenario</th><th>Status</th><th>Error Message</th></tr></thead>
                        <tbody>
                            <tr><td>Invalid API key</td><td><code>ERROR</code></td><td>"Invalid or disabled API key"</td></tr>
                            <tr><td>Unknown request_type</td><td><code>ERROR</code></td><td>"No handler found for request_type='XYZ'"</td></tr>
                            <tr><td>Handler class not found</td><td><code>ERROR</code></td><td>"Handler execution failed: ClassNotFoundException"</td></tr>
                            <tr><td>Handler throws exception</td><td><code>ERROR</code></td><td>"Handler execution failed: [exception message]"</td></tr>
                            <tr><td>TTL expired</td><td><code>TIMEOUT</code></td><td>"Request exceeded TTL and was terminated"</td></tr>
                            <tr><td>Proxy: no execute method found</td><td><code>ERROR</code></td><td>"No execute-compatible method found in [ClassName]"</td></tr>
                            <tr><td>Handler stopped externally</td><td><code>ERROR</code></td><td>"Handler was stopped"</td></tr>
                        </tbody>
                    </table>
                </section>

                <div class="mt-5 text-center">
                    <a href="/help/channels" class="btn btn-outline-primary"><i class="fas fa-arrow-left me-2"></i>Channels</a>
                    <a href="/help" class="btn btn-outline-secondary ms-2"><i class="fas fa-home me-2"></i>Help Index</a>
                    <a href="/help/brokers" class="btn btn-primary ms-2">Broker Configuration<i class="fas fa-arrow-right ms-2"></i></a>
                </div>
            </div>
        </div>

        <footer class="py-4 mt-5 border-top">
            <div class="row">
                <div class="col-md-6"><h6><i class="fas fa-network-wired me-2"></i><span th:text="${appName} ?: 'DGFacade'">DGFacade</span></h6><p class="text-muted small mb-0">Version <span th:text="${version} ?: '1.2.0'">1.2.0</span></p></div>
                <div class="col-md-6 text-end"><p class="text-muted small mb-0">Copyright &copy; 2025-2030 Ashutosh Sinha<br><span class="badge bg-warning text-dark">Patent Pending</span></p></div>
            </div>
        </footer>
    </div>
</main>
<th:block th:replace="~{fragments/layout :: scripts}"></th:block>
</body>
</html>
