<!DOCTYPE html>
<!--
  ~ Copyright © 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  ~ Proprietary and confidential. Patent Pending.
  -->
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('Test Handler')}"></head>
<body class="d-flex flex-column min-vh-100">
<nav th:replace="~{fragments/layout :: navbar}"></nav>

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-5">
            <h4>
                <i class="fas fa-play-circle me-2"></i> Test Handler:
                <code th:text="${handlerType}">HANDLER</code>
                <span th:if="${isStreaming}" class="badge bg-info ms-2"><i class="fas fa-stream me-1"></i> Streaming</span>
            </h4>
            <p class="text-muted" th:text="${handlerDescription}">Description</p>
            <hr>

            <!-- Request JSON editor -->
            <div class="card mb-3">
                <div class="card-header"><h6 class="mb-0">Request JSON</h6></div>
                <div class="card-body p-0">
                    <textarea id="requestJson" class="form-control font-monospace border-0"
                              rows="16" th:text="${sampleRequest}"></textarea>
                </div>
            </div>

            <div class="d-flex gap-2 mb-3">
                <button id="btnSend" class="btn btn-primary" onclick="sendRequest()">
                    <i class="fas fa-paper-plane me-1"></i> Send Request
                </button>
                <button th:if="${isStreaming}" id="btnStop" class="btn btn-danger d-none" onclick="stopStreaming()">
                    <i class="fas fa-stop me-1"></i> Stop Streaming
                </button>
                <button id="btnClear" class="btn btn-outline-secondary" onclick="clearOutput()">
                    <i class="fas fa-eraser me-1"></i> Clear
                </button>
            </div>

            <!-- Connection status (streaming only) -->
            <div th:if="${isStreaming}" id="wsStatus" class="alert alert-secondary py-2 small">
                <i class="fas fa-circle text-secondary me-1"></i> WebSocket: Disconnected
            </div>
        </div>

        <div class="col-md-7">
            <h4><i class="fas fa-terminal me-2"></i> Response</h4>
            <hr>

            <!-- Initial response card -->
            <div id="initialResponse" class="card mb-3 d-none">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0" id="responseTitle">Response</h6>
                    <span id="responseStatusBadge" class="badge bg-secondary">—</span>
                </div>
                <div class="card-body p-0">
                    <pre id="responseJson" class="p-3 mb-0"
                         style="max-height: 300px; overflow-y: auto; font-size: 0.85rem;"></pre>
                </div>
            </div>

            <!-- Streaming data panel (streaming only) -->
            <div th:if="${isStreaming}">
                <div class="card" id="streamPanel">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-stream me-1"></i> Live Stream
                            <span id="msgCount" class="badge bg-primary ms-2">0 messages</span>
                        </h6>
                        <div>
                            <label class="form-check-label me-2 small text-muted" for="autoScroll">Auto-scroll</label>
                            <input type="checkbox" id="autoScroll" class="form-check-input" checked>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="streamOutput"
                             style="height: 400px; overflow-y: auto; font-size: 0.82rem; font-family: monospace; background: #1e1e1e; color: #d4d4d4; padding: 12px;">
                            <div class="text-muted">Waiting for streaming data...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{fragments/layout :: footer}"></footer>
<th:block th:replace="~{fragments/layout :: scripts}"></th:block>

<!-- SockJS + STOMP for WebSocket (streaming handlers only) -->
<script th:if="${isStreaming}" th:src="@{/webjars/sockjs-client/1.5.1/sockjs.min.js}"></script>
<script th:if="${isStreaming}" th:src="@{/webjars/stomp-websocket/2.3.4/stomp.min.js}"></script>

<script th:inline="javascript">
    const IS_STREAMING = /*[[${isStreaming}]]*/ false;
    let stompClient = null;
    let currentSessionId = null;
    let messageCount = 0;

    function sendRequest() {
        const jsonText = document.getElementById('requestJson').value.trim();
        let request;
        try {
            request = JSON.parse(jsonText);
        } catch (e) {
            showError('Invalid JSON: ' + e.message);
            return;
        }

        document.getElementById('btnSend').disabled = true;
        document.getElementById('btnSend').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Sending...';

        fetch('/api/v1/request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(request)
        })
        .then(resp => resp.json())
        .then(data => {
            showInitialResponse(data);

            // If this is a streaming response, connect WebSocket
            if (IS_STREAMING && data.status === 'STREAMING_STARTED' && data.result && data.result.sessionId) {
                currentSessionId = data.result.sessionId;
                connectWebSocket(currentSessionId);
                document.getElementById('btnStop').classList.remove('d-none');
                document.getElementById('btnSend').classList.add('d-none');
            } else {
                document.getElementById('btnSend').disabled = false;
                document.getElementById('btnSend').innerHTML = '<i class="fas fa-paper-plane me-1"></i> Send Request';
            }
        })
        .catch(err => {
            showError('Request failed: ' + err.message);
            document.getElementById('btnSend').disabled = false;
            document.getElementById('btnSend').innerHTML = '<i class="fas fa-paper-plane me-1"></i> Send Request';
        });
    }

    function showInitialResponse(data) {
        document.getElementById('initialResponse').classList.remove('d-none');
        document.getElementById('responseJson').textContent = JSON.stringify(data, null, 2);

        const badge = document.getElementById('responseStatusBadge');
        badge.textContent = data.status || '—';
        badge.className = 'badge ' + statusColor(data.status);

        const title = document.getElementById('responseTitle');
        if (data.status === 'STREAMING_STARTED') {
            title.textContent = 'Streaming Session Started';
        } else {
            title.textContent = 'Response — ' + (data.executionTimeMs || 0) + 'ms';
        }
    }

    function showError(msg) {
        document.getElementById('initialResponse').classList.remove('d-none');
        document.getElementById('responseJson').textContent = msg;
        document.getElementById('responseStatusBadge').textContent = 'ERROR';
        document.getElementById('responseStatusBadge').className = 'badge bg-danger';
    }

    function statusColor(status) {
        switch (status) {
            case 'SUCCESS': return 'bg-success';
            case 'STREAMING_STARTED': return 'bg-info';
            case 'STREAMING_DATA': return 'bg-primary';
            case 'STREAMING_ENDED': return 'bg-secondary';
            case 'ERROR': case 'UNAUTHORIZED': case 'HANDLER_NOT_FOUND': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }

    // ── WebSocket (streaming) ───────────────────────────

    function connectWebSocket(sessionId) {
        const wsStatus = document.getElementById('wsStatus');
        wsStatus.innerHTML = '<i class="fas fa-circle text-warning me-1"></i> WebSocket: Connecting...';

        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // suppress debug logs

        stompClient.connect({}, function(frame) {
            wsStatus.innerHTML = '<i class="fas fa-circle text-success me-1"></i> WebSocket: Connected — Session: <code>' + sessionId.substring(0, 8) + '...</code>';
            wsStatus.className = 'alert alert-success py-2 small';

            // Subscribe to the streaming topic for this session
            stompClient.subscribe('/topic/stream/' + sessionId, function(message) {
                const data = JSON.parse(message.body);
                appendStreamMessage(data);
            });
        }, function(error) {
            wsStatus.innerHTML = '<i class="fas fa-circle text-danger me-1"></i> WebSocket: Error — ' + error;
            wsStatus.className = 'alert alert-danger py-2 small';
        });
    }

    function appendStreamMessage(data) {
        messageCount++;
        const output = document.getElementById('streamOutput');

        // Clear placeholder
        if (messageCount === 1) {
            output.innerHTML = '';
        }

        const div = document.createElement('div');
        div.style.borderBottom = '1px solid #333';
        div.style.paddingBottom = '4px';
        div.style.marginBottom = '4px';

        // Check for end-of-stream
        if (data.status === 'STREAMING_ENDED') {
            div.style.color = '#e0a030';
            div.innerHTML = '<strong>── Stream Ended ──</strong>\n' + JSON.stringify(data.result, null, 2);
            onStreamEnded();
        } else {
            const ts = data.result && data.result.tickTimestamp
                ? new Date(data.result.tickTimestamp).toLocaleTimeString()
                : new Date().toLocaleTimeString();
            div.innerHTML = '<span style="color:#569cd6;">[' + ts + ' #' + messageCount + ']</span> ' +
                            JSON.stringify(data.result, null, 2);
        }

        output.appendChild(div);

        // Auto-scroll
        if (document.getElementById('autoScroll').checked) {
            output.scrollTop = output.scrollHeight;
        }

        document.getElementById('msgCount').textContent = messageCount + ' messages';
    }

    function stopStreaming() {
        if (currentSessionId) {
            fetch('/api/v1/streaming/sessions/' + currentSessionId, { method: 'DELETE' })
            .then(resp => resp.json())
            .then(data => {
                appendStreamMessage({ status: 'STREAMING_ENDED',
                    result: { reason: 'Manual stop', sessionId: currentSessionId } });
            })
            .catch(err => console.error('Stop failed', err));
        }
    }

    function onStreamEnded() {
        if (stompClient) {
            stompClient.disconnect();
            stompClient = null;
        }
        const wsStatus = document.getElementById('wsStatus');
        if (wsStatus) {
            wsStatus.innerHTML = '<i class="fas fa-circle text-secondary me-1"></i> WebSocket: Disconnected (stream ended)';
            wsStatus.className = 'alert alert-secondary py-2 small';
        }
        document.getElementById('btnStop').classList.add('d-none');
        document.getElementById('btnSend').classList.remove('d-none');
        document.getElementById('btnSend').disabled = false;
        document.getElementById('btnSend').innerHTML = '<i class="fas fa-paper-plane me-1"></i> Send Request';
        currentSessionId = null;
    }

    function clearOutput() {
        document.getElementById('initialResponse').classList.add('d-none');
        document.getElementById('responseJson').textContent = '';
        if (IS_STREAMING) {
            document.getElementById('streamOutput').innerHTML = '<div class="text-muted">Waiting for streaming data...</div>';
            messageCount = 0;
            document.getElementById('msgCount').textContent = '0 messages';
        }
    }
</script>
</body>
</html>
