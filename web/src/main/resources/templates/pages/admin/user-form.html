<!DOCTYPE html>
<!--
  ~ Copyright © 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  ~ Proprietary and confidential.
  -->
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('Create User')}"></head>
<body class="d-flex flex-column min-vh-100">
<nav th:replace="~{fragments/layout :: navbar}"></nav>
<main class="flex-fill">
    <div th:replace="~{fragments/layout :: alerts}"></div>
    <div class="container-fluid py-4">

        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2">
                        <li class="breadcrumb-item"><a th:href="@{/admin/users}">Users</a></li>
                        <li class="breadcrumb-item active">Create New User</li>
                    </ol>
                </nav>
                <h2 class="mb-0"><i class="fas fa-user-plus me-2"></i>Create New User</h2>
            </div>
            <div class="col-auto">
                <a th:href="@{/admin/users}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-1"></i>Back to Users</a>
            </div>
        </div>

        <form th:action="@{/admin/users/create}" method="post">

        <div class="row g-4">
            <!-- ════════════ LEFT COLUMN: Form ════════════ -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0"><i class="fas fa-id-card me-2 text-primary"></i>Account Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Username <span class="text-danger">*</span></label>
                                <input type="text" name="username" class="form-control" required
                                       placeholder="e.g. jsmith, svc-orders"
                                       pattern="[a-zA-Z0-9._\-]+" title="Letters, numbers, dots, hyphens, underscores">
                                <div class="form-text">Login name. Alphanumeric, dots, hyphens, and underscores only.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Password <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="text" name="password" id="passwordField" class="form-control" required
                                           placeholder="e.g. S3cur3Pa$$">
                                    <button type="button" class="btn btn-outline-secondary" onclick="generatePassword()" title="Generate random password">
                                        <i class="fas fa-dice"></i>
                                    </button>
                                </div>
                                <div class="form-text">Stored in <code>config/users.json</code>. Passwords are cleartext in this version — protect the config file accordingly.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Display Name <span class="text-danger">*</span></label>
                                <input type="text" name="displayName" class="form-control" required
                                       placeholder="e.g. John Smith">
                                <div class="form-text">Human-readable name shown in the UI and audit logs.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Email</label>
                                <input type="email" name="email" class="form-control"
                                       placeholder="e.g. jsmith@company.com">
                                <div class="form-text">Optional. Used for notifications and contact purposes.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0"><i class="fas fa-shield-alt me-2 text-danger"></i>Role Assignment</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Roles <span class="text-danger">*</span></label>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="roles" value="USER" id="roleUser" checked>
                                    <label class="form-check-label" for="roleUser">
                                        <span class="badge bg-primary me-1">USER</span> Standard access
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="roles" value="ADMIN" id="roleAdmin">
                                    <label class="form-check-label" for="roleAdmin">
                                        <span class="badge bg-danger me-1">ADMIN</span> Full system access
                                    </label>
                                </div>
                                <div class="form-text mt-2">Select one or both roles. At minimum, USER is required for API access.</div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-light border mb-0 small">
                                    <h6 class="fw-bold"><i class="fas fa-info-circle me-1 text-info"></i>Role Details</h6>
                                    <dl class="mb-0">
                                        <dt><span class="badge bg-primary">USER</span></dt>
                                        <dd class="text-muted mb-2">View dashboard, submit requests via REST/WebSocket API, view handler execution states.</dd>
                                        <dt><span class="badge bg-danger">ADMIN</span></dt>
                                        <dd class="text-muted mb-0">All USER permissions plus: manage users, API keys, broker configurations, channel configurations, and system settings.</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit -->
                <div class="d-flex gap-2 mb-5">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-user-plus me-1"></i>Create User
                    </button>
                    <a th:href="@{/admin/users}" class="btn btn-outline-secondary btn-lg">Cancel</a>
                </div>
            </div>

            <!-- ════════════ RIGHT COLUMN: Help ════════════ -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm mb-4 sticky-top" style="top: 80px">
                    <div class="card-header bg-primary text-white py-3">
                        <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>User Management Tips</h6>
                    </div>
                    <div class="card-body small">
                        <h6 class="fw-bold text-primary">User ID</h6>
                        <p class="text-muted">A unique 8-character ID is generated automatically from a UUID when the user is created.</p>

                        <h6 class="fw-bold text-primary">API Keys</h6>
                        <p class="text-muted">After creating the user, go to <a th:href="@{/admin/apikeys}">API Keys</a> to generate one or more API keys for programmatic access.</p>

                        <h6 class="fw-bold text-primary">Service Accounts</h6>
                        <p class="text-muted">For non-human clients, use a naming convention like <code>svc-orders</code> or <code>bot-monitoring</code> to distinguish service accounts from human users.</p>

                        <h6 class="fw-bold text-primary">Password Security</h6>
                        <p class="text-muted">Passwords are stored in cleartext in <code>config/users.json</code>. Protect this file with OS-level permissions. A future version will add bcrypt hashing.</p>

                        <h6 class="fw-bold text-primary">Authentication Flow</h6>
                        <p class="text-muted mb-0">
                            <strong>UI Login:</strong> Username + password via form login.<br>
                            <strong>API Access:</strong> Include <code>"api_key": "dgf-xxx"</code> in the request JSON body.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        </form>
    </div>
</main>
<footer th:replace="~{fragments/layout :: footer}"></footer>
<th:block th:replace="~{fragments/layout :: scripts}"></th:block>
<script>
function generatePassword() {
    var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$%';
    var pw = '';
    for (var i = 0; i < 16; i++) pw += chars.charAt(Math.floor(Math.random() * chars.length));
    document.getElementById('passwordField').value = pw;
}
</script>
</body>
</html>
